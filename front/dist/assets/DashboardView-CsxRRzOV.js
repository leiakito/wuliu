import{j as dt,d as ut,u as ct,k as mt,r as D,a as ft,m as pt,n as _t,c as H,b as e,p as K,q as M,w as a,e as b,s as gt,o as x,h as l,t as d,v as ht,x as u,y as I,z as vt,A as bt,B as kt,i as g,C as yt,D as Ct,F as wt,G as St,H as Ft,I as N,J as Dt,K as Nt,E as U,f as Tt,g as At,L as xt,_ as It}from"./index-DSeUM942.js";import{s as Bt}from"./orders-BGoj80BM.js";const Et=j=>dt.get("/report/dashboard",{params:j}),$t={class:"page dashboard-page"},Ot={class:"stat-content"},Vt={class:"stat-icon"},zt={class:"stat-info"},Rt={class:"stat-value"},Mt={class:"stat-trend"},Ut={class:"stat-content"},jt={class:"stat-icon"},Lt={class:"stat-info"},qt={class:"stat-value"},Pt={class:"stat-trend"},Gt={class:"stat-content"},Ht={class:"stat-icon"},Kt={class:"stat-info"},Jt={class:"stat-value"},Yt={class:"stat-trend"},Zt={class:"stat-content"},Qt={class:"stat-icon"},Wt={class:"stat-info"},Xt={class:"stat-value"},te={class:"stat-trend"},ee={class:"action-buttons"},se={class:"card-header"},ae={class:"actions"},ne={class:"card-header"},le=ut({__name:"DashboardView",setup(j){const J=ct(),B=Tt(),Y=At(),E=mt(()=>{var s;return((s=J.user)==null?void 0:s.role)==="ADMIN"}),$=D(""),O=D(!1),k=D([]),L=D(),V=D(!1),y=ft({orderCount:0,waitingSettlementCount:0,totalAmount:0,pendingAmount:0}),z=(s,t=!0)=>{const o=new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(s||0);return t?`¥${o}`:o};pt(async()=>{try{const s=await Et({});s&&(y.orderCount=s.orderCount??0,y.waitingSettlementCount=s.waitingSettlementCount??0,y.totalAmount=Number(s.totalAmount??0),y.pendingAmount=Number(s.pendingAmount??0))}catch(s){console.warn("加载仪表盘统计失败",s)}});const q=[{value:"UNPAID",label:"未打款",tag:"warning"},{value:"NOT_RECEIVED",label:"未收货",tag:"info"},{value:"PAID",label:"已打款",tag:"success"}],Z=s=>{var t;return((t=q.find(o=>o.value===s))==null?void 0:t.label)??"未知"},Q=s=>{var t;return((t=q.find(o=>o.value===s))==null?void 0:t.tag)??"info"},W=s=>s?s.replace("T"," ").replace("Z",""):"-",S=(s,t)=>{try{const r={tracking:{bg:s.trackingBgColor,fg:s.trackingFontColor,strike:s.trackingStrike},model:{bg:s.modelBgColor,fg:s.modelFontColor,strike:s.modelStrike},sn:{bg:s.snBgColor,fg:s.snFontColor,strike:s.snStrike},amount:{bg:s.amountBgColor,fg:s.amountFontColor,strike:s.amountStrike},remark:{bg:s.remarkBgColor,fg:s.remarkFontColor,strike:s.remarkStrike}}[t];if(!r)return{};const m={};return r.bg&&r.bg!=="#FFFFFF"&&r.bg!=="#FFF"&&String(r.bg).trim()!==""&&(m["background-color"]=r.bg),r.fg&&r.fg!=="#000000"&&r.fg!=="#000"&&String(r.fg).trim()!==""&&(m.color=r.fg),(r.strike===!0||r.strike==="true"||r.strike===1)&&(m["text-decoration"]="line-through"),m}catch(o){return console.warn("样式应用失败:",o),{}}},X=async()=>{const s=$.value.split(/\n|,|;/).map(t=>t.trim()).filter(Boolean);if(!s.length){U.warning("请先输入单号或 SN");return}O.value=!0;try{const t=await Bt(s);if(!t.length){U.warning("未查询到对应订单");return}k.value=t}finally{O.value=!1}},tt=()=>{k.value=[]},et=s=>{const t=s==null?"":String(s);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t},T=s=>{if(!s)return null;const t=new Date(s);return Number.isNaN(t.getTime())?null:t},st=s=>{const t=T(s);if(!t)return"";const o=r=>r.toString().padStart(2,"0");return`${t.getFullYear()}/${o(t.getMonth()+1)}/${o(t.getDate())} ${o(t.getHours())}:${o(t.getMinutes())}`},at=()=>{if(!k.value.length){U.warning("没有可导出的数据");return}const s=["时间","订单号","商品名","SN/条码","价格","备注","","","","归属人"],t=new Map,o=(n,f)=>`${n}|${f?f.toISOString():""}`,r=n=>T(n.orderTime)||T(n.createdAt)||T(n.updatedAt)||(n.orderDate?new Date(`${n.orderDate}T00:00:00`):null);k.value.forEach(n=>{var i;const f=((i=n.trackingNumber)==null?void 0:i.trim())||"";if(!f)return;const h=r(n),p=o(f,h);t.has(p)||t.set(p,{key:p,time:h,timeText:h?st(h.toISOString()):"",tracking:f,items:[]}),t.get(p).items.push(n)});const m=Array.from(t.values()).sort((n,f)=>{var i,v;const h=((i=n.time)==null?void 0:i.getTime())??0,p=((v=f.time)==null?void 0:v.getTime())??0;return h!==p?h-p:n.tracking.localeCompare(f.tracking)}),w=[];let _="";m.forEach(n=>{const f=n.items.reduce((i,v)=>{const C=(v.createdBy??"").trim();return i[C]=i[C]||[],i[C].push(v),i},{}),h=Object.entries(f).sort((i,v)=>i[0].localeCompare(v[0]));let p=!0;h.forEach(([i,v])=>{_&&i!==_&&(w.push(new Array(s.length).fill("")),w.push(new Array(s.length).fill("")),w.push(new Array(s.length).fill(""))),_=i,v.forEach((C,P)=>{var G;const rt=p&&P===0?n.timeText:"",it=p&&P===0?n.tracking:"";p=!1,w.push([rt,it,C.model??"",C.sn??"",((G=C.amount)==null?void 0:G.toString())??"",C.remark??"","","","",i||""])})})});const A=[s,...w].map(n=>n.map(et).join(",")).join(`
`),R=new Blob(["\uFEFF"+A],{type:"text/csv;charset=utf-8;"}),c=window.URL.createObjectURL(R),F=document.createElement("a");F.href=c,F.download=`dashboard-results-${new Date().toISOString().slice(0,10)}.csv`,F.click(),window.URL.revokeObjectURL(c)},nt=()=>{B.push("/orders")},lt=()=>{B.push("/settlements")},ot=()=>{B.push("/users")};return _t(()=>Y.query.focus,async s=>{var t,o;s==="profile"&&(await xt(),V.value=!0,(o=(t=L.value)==null?void 0:t.$el)==null||o.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{V.value=!1},1500))},{immediate:!0}),(s,t)=>{const o=b("el-icon"),r=b("el-card"),m=b("el-col"),w=b("el-row"),_=b("el-button"),A=b("el-tag"),R=b("el-input"),c=b("el-table-column"),F=b("el-table");return x(),H("div",$t,[e(w,{gutter:16,class:"stats-row"},{default:a(()=>[e(m,{xs:24,sm:12,md:6},{default:a(()=>[e(r,{class:"stat-card stat-card--primary",shadow:"hover"},{default:a(()=>[l("div",Ot,[l("div",Vt,[e(o,{size:32},{default:a(()=>[e(d(ht))]),_:1})]),l("div",zt,[t[2]||(t[2]=l("div",{class:"stat-label"},"订单总数",-1)),l("div",Rt,u(y.orderCount),1),l("div",Mt,[e(o,{class:"trend-up"},{default:a(()=>[e(d(I))]),_:1}),t[1]||(t[1]=l("span",null,"较上月 +12%",-1))])])])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:6},{default:a(()=>[e(r,{class:"stat-card stat-card--success",shadow:"hover"},{default:a(()=>[l("div",Ut,[l("div",jt,[e(o,{size:32},{default:a(()=>[e(d(vt))]),_:1})]),l("div",Lt,[t[4]||(t[4]=l("div",{class:"stat-label"},"待结账数",-1)),l("div",qt,u(y.waitingSettlementCount),1),l("div",Pt,[e(o,{class:"trend-up"},{default:a(()=>[e(d(I))]),_:1}),t[3]||(t[3]=l("span",null,"较上月 +8%",-1))])])])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:6},{default:a(()=>[e(r,{class:"stat-card stat-card--warning",shadow:"hover"},{default:a(()=>[l("div",Gt,[l("div",Ht,[e(o,{size:32},{default:a(()=>[e(d(bt))]),_:1})]),l("div",Kt,[t[6]||(t[6]=l("div",{class:"stat-label"},"待结账金额",-1)),l("div",Jt,u(z(y.pendingAmount)),1),l("div",Yt,[e(o,{class:"trend-down"},{default:a(()=>[e(d(I))]),_:1}),t[5]||(t[5]=l("span",null,"较上月 -5%",-1))])])])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:6},{default:a(()=>[e(r,{class:"stat-card stat-card--info",shadow:"hover"},{default:a(()=>[l("div",Zt,[l("div",Qt,[e(o,{size:32},{default:a(()=>[e(d(kt))]),_:1})]),l("div",Wt,[t[8]||(t[8]=l("div",{class:"stat-label"},"总金额",-1)),l("div",Xt,u(z(y.totalAmount)),1),l("div",te,[e(o,{class:"trend-up"},{default:a(()=>[e(d(I))]),_:1}),t[7]||(t[7]=l("span",null,"较上月 +15%",-1))])])])]),_:1})]),_:1})]),_:1}),E.value?(x(),K(r,{key:0,class:"quick-actions"},{header:a(()=>[...t[9]||(t[9]=[l("div",{class:"card-header"},[l("span",null,"快速操作")],-1)])]),default:a(()=>[l("div",ee,[e(_,{type:"primary",onClick:nt},{default:a(()=>[e(o,null,{default:a(()=>[e(d(yt))]),_:1}),t[10]||(t[10]=g(" 新建订单 ",-1))]),_:1}),e(_,{type:"success",onClick:lt},{default:a(()=>[e(o,null,{default:a(()=>[e(d(Ct))]),_:1}),t[11]||(t[11]=g(" 结算管理 ",-1))]),_:1}),e(_,{type:"info",onClick:ot},{default:a(()=>[e(o,null,{default:a(()=>[e(d(wt))]),_:1}),t[12]||(t[12]=g(" 用户管理 ",-1))]),_:1})])]),_:1})):M("",!0),e(r,{ref_key:"profileCard",ref:L,class:gt([{highlight:V.value},"search-panel"])},{header:a(()=>[l("div",se,[t[13]||(t[13]=l("span",null,"单号查询",-1)),e(A,{size:"small",type:E.value?"danger":"info"},{default:a(()=>[g(u(E.value?"管理员":"用户"),1)]),_:1},8,["type"])])]),default:a(()=>[e(R,{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=n=>$.value=n),type:"textarea",rows:4,placeholder:"支持多个单号或 SN，换行 / 逗号 / 分号分隔"},null,8,["modelValue"]),l("div",ae,[e(_,{type:"primary",loading:O.value,onClick:X},{default:a(()=>[e(o,null,{default:a(()=>[e(d(St))]),_:1}),t[14]||(t[14]=g(" 查询 ",-1))]),_:1},8,["loading"]),e(_,{text:"",disabled:!k.value.length,onClick:tt},{default:a(()=>[e(o,null,{default:a(()=>[e(d(Ft))]),_:1}),t[15]||(t[15]=g(" 清空结果 ",-1))]),_:1},8,["disabled"])]),t[16]||(t[16]=l("p",{class:"tips"},' 如需录入、批量导入或导出，请切换到左侧导航的"物流单号"模块；查询结果仅保留在当前页面。 ',-1))]),_:1},8,["class"]),k.value.length?(x(),K(r,{key:1,class:"table-card"},{header:a(()=>[l("div",ne,[l("span",null,"查询结果 ("+u(k.value.length)+" 条)",1),e(_,{type:"primary",size:"small",onClick:at},{default:a(()=>[e(o,null,{default:a(()=>[e(d(Nt))]),_:1}),t[17]||(t[17]=g(" 导出结果 ",-1))]),_:1})])]),default:a(()=>[e(F,{data:k.value,style:{width:"100%"},stripe:""},{default:a(()=>[e(c,{prop:"orderDate",label:"下单日期",width:"140"}),e(c,{prop:"orderTime",label:"时间",width:"180"},{default:a(({row:n})=>[g(u(W(n.orderTime)),1)]),_:1}),e(c,{prop:"trackingNumber",label:"运单号",width:"200"},{default:a(({row:n})=>[l("span",{style:N(S(n,"tracking"))},u(n.trackingNumber),5)]),_:1}),e(c,{prop:"model",label:"型号"},{default:a(({row:n})=>[l("span",{style:N(S(n,"model"))},u(n.model||"-"),5)]),_:1}),e(c,{prop:"sn",label:"SN",width:"200"},{default:a(({row:n})=>[l("span",{style:N(S(n,"sn"))},u(n.sn||"-"),5)]),_:1}),e(c,{prop:"category",label:"分类",width:"120"}),e(c,{prop:"amount",label:"金额",width:"120"},{default:a(({row:n})=>[l("span",{style:N(S(n,"amount"))},[n.amount!==null&&n.amount!==void 0?(x(),H(Dt,{key:0},[g("￥"+u(z(n.amount,!1)),1)],64)):M("",!0)],4)]),_:1}),e(c,{prop:"status",label:"状态",width:"140"},{default:a(({row:n})=>[e(A,{type:Q(n.status)},{default:a(()=>[g(u(Z(n.status)),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"remark",label:"备注"},{default:a(({row:n})=>[l("span",{style:N(S(n,"remark"))},u(n.remark||"-"),5)]),_:1})]),_:1},8,["data"])]),_:1})):M("",!0)])}}}),ie=It(le,[["__scopeId","data-v-b664a151"]]);export{ie as default};

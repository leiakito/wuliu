import{y as D,d as le,u as re,j as E,a as H,r as P,k as T,c as R,e as g,b as t,n as K,w as r,g as d,f as m,F as oe,s as ne,v as ie,x as se,m as F,t as de,E as b,C as me,o as v,_ as ue}from"./index-xnLysfLr.js";const pe=u=>D.get("/hardware/prices",{params:u}),ce=u=>D.post("/hardware/prices",u),fe=u=>D.post("/hardware/prices/batch",u),ge=(u,x)=>D.put(`/hardware/prices/${u}`,x),ye=u=>D.delete(`/hardware/prices/${u}`),be={class:"page"},ve={class:"page-header"},we={key:0,class:"actions"},Ve={class:"batch-form"},De=le({__name:"HardwarePricesView",setup(u){const x=re(),j=E(()=>{var l;return((l=x.user)==null?void 0:l.role)==="ADMIN"}),i=H({range:[],category:""}),Y=P(!1),B=P([]),S=P(!1),o=H({visible:!1,loading:!1,editingId:0,form:{priceDate:"",itemName:"",category:"",price:0,remark:""}}),n=H({visible:!1,loading:!1,form:{priceDate:"",category:"",price:null},raw:""}),$=P(),L={priceDate:[{required:!0,message:"请选择日期",trigger:"change"}],itemName:[{required:!0,message:"请输入名称",trigger:"blur"}],price:[{required:!0,message:"请输入价格",trigger:"change"}]},X=E(()=>Array.from(new Set(B.value.map(l=>l.category).filter(l=>!!l)))),z=E(()=>B.value),J=()=>{const l=new Date,e=new Date;return e.setDate(l.getDate()-6),[I(e),I(l)]},I=l=>l.toISOString().slice(0,10),y=async()=>{S.value=!0;try{const l={};Array.isArray(i.range)&&i.range.length===2&&(l.startDate=i.range[0],l.endDate=i.range[1]),i.category&&(l.category=i.category),B.value=await pe(l)}finally{S.value=!1}},O=()=>{Y.value=!0,i.range=J(),i.category="",Y.value=!1,y()},q=l=>{l?(o.editingId=l.id,Object.assign(o.form,{priceDate:l.priceDate,itemName:l.itemName,category:l.category??"",price:l.price,remark:l.remark??""})):(o.editingId=0,Object.assign(o.form,{priceDate:i.range[1]||I(new Date),itemName:"",category:i.category||"",price:0,remark:""})),o.visible=!0},Q=()=>{n.raw="",n.form.priceDate="",n.form.category=i.category||"",n.form.price=null,n.visible=!0},W=async()=>{if(!(!$.value||!await $.value.validate().catch(()=>!1))){o.loading=!0;try{o.editingId?(await ge(o.editingId,o.form),b.success("更新成功")):(await ce(o.form),b.success("新增成功")),o.visible=!1,y()}finally{o.loading=!1}}},Z=async l=>{await me.confirm(`确认删除 ${l.itemName} 的报价吗？`,"提示",{type:"warning"}),await ye(l.id),b.success("已删除"),y()},h=l=>(l??0).toFixed(2),ee=()=>n.raw.split(/\n+/).map(e=>e.trim()).filter(Boolean).map((e,s)=>{const w=e.split(/[,，\t]/),[p,_,M,k,...C]=w.map(A=>A.trim()),c=p||n.form.priceDate,N=M||n.form.category,f=k||String(n.form.price??"");if(!c||!_||!N||!f)throw new Error(`第 ${s+1} 行格式不正确`);const V=Number(f);if(Number.isNaN(V))throw new Error(`第 ${s+1} 行价格无效`);const U=C.join(" ").trim();return{priceDate:c,itemName:_,category:N,price:V,remark:U||void 0}}),te=async()=>{let l;try{l=ee()}catch(e){b.error(e instanceof Error?e.message:"格式解析失败");return}if(!l.length){b.warning("请先输入内容");return}n.loading=!0;try{await fe({items:l}),b.success("批量录入成功"),n.visible=!1,n.raw="",y()}finally{n.loading=!1}},G=()=>{Y.value||y()};return T(()=>i.category,G),T(()=>i.range,G,{deep:!0}),O(),(l,e)=>{const s=m("el-button"),w=m("el-date-picker"),p=m("el-form-item"),_=m("el-option"),M=m("el-select"),k=m("el-form"),C=m("el-card"),c=m("el-table-column"),N=m("el-table"),f=m("el-input"),V=m("el-input-number"),U=m("el-dialog"),A=se("loading");return v(),R("div",be,[g("div",ve,[e[18]||(e[18]=g("div",null,[g("h2",null,"硬件价格"),g("p",{class:"sub"},"按日期记录 CPU / 主板 / GPU 等硬件价格")],-1)),j.value?(v(),R("div",we,[t(s,{onClick:Q},{default:r(()=>[...e[16]||(e[16]=[d("批量录入",-1)])]),_:1}),t(s,{type:"primary",onClick:e[0]||(e[0]=a=>q())},{default:r(()=>[...e[17]||(e[17]=[d("新增价格",-1)])]),_:1})])):K("",!0)]),t(C,null,{default:r(()=>[t(k,{inline:!0,model:i,class:"filter-form"},{default:r(()=>[t(p,{label:"日期"},{default:r(()=>[t(w,{modelValue:i.range,"onUpdate:modelValue":e[1]||(e[1]=a=>i.range=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD","unlink-panels":""},null,8,["modelValue"])]),_:1}),t(p,null,{default:r(()=>[t(s,{type:"primary",onClick:y},{default:r(()=>[...e[19]||(e[19]=[d("查询",-1)])]),_:1}),t(s,{onClick:O},{default:r(()=>[...e[20]||(e[20]=[d("最近 7 天",-1)])]),_:1})]),_:1}),t(p,{label:"分类"},{default:r(()=>[t(M,{modelValue:i.category,"onUpdate:modelValue":e[2]||(e[2]=a=>i.category=a),placeholder:"全部",clearable:"",filterable:"",style:{width:"160px"}},{default:r(()=>[(v(!0),R(oe,null,ne(X.value,a=>(v(),F(_,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),t(C,{class:"table-card"},{default:r(()=>[ie((v(),F(N,{data:z.value},{default:r(()=>[t(c,{prop:"priceDate",label:"日期",width:"140"}),t(c,{prop:"itemName",label:"硬件"}),t(c,{prop:"category",label:"分类",width:"140"}),t(c,{prop:"price",label:"价格",width:"140"},{default:r(({row:a})=>[d("￥"+de(h(a.price)),1)]),_:1}),t(c,{prop:"remark",label:"备注"}),t(c,{prop:"createdBy",label:"录入人",width:"140"}),j.value?(v(),F(c,{key:0,label:"操作",width:"160"},{default:r(({row:a})=>[t(s,{link:"",type:"primary",onClick:ae=>q(a)},{default:r(()=>[...e[21]||(e[21]=[d("编辑",-1)])]),_:1},8,["onClick"]),t(s,{link:"",type:"danger",onClick:ae=>Z(a)},{default:r(()=>[...e[22]||(e[22]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1})):K("",!0)]),_:1},8,["data"])),[[A,S.value]])]),_:1}),t(U,{modelValue:o.visible,"onUpdate:modelValue":e[9]||(e[9]=a=>o.visible=a),title:"硬件价格",width:"520px"},{footer:r(()=>[t(s,{onClick:e[8]||(e[8]=a=>o.visible=!1)},{default:r(()=>[...e[23]||(e[23]=[d("取消",-1)])]),_:1}),t(s,{type:"primary",loading:o.loading,onClick:W},{default:r(()=>[...e[24]||(e[24]=[d("保存",-1)])]),_:1},8,["loading"])]),default:r(()=>[t(k,{ref_key:"formRef",ref:$,model:o.form,rules:L,"label-width":"90px"},{default:r(()=>[t(p,{label:"日期",prop:"priceDate"},{default:r(()=>[t(w,{modelValue:o.form.priceDate,"onUpdate:modelValue":e[3]||(e[3]=a=>o.form.priceDate=a),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(p,{label:"硬件名称",prop:"itemName"},{default:r(()=>[t(f,{modelValue:o.form.itemName,"onUpdate:modelValue":e[4]||(e[4]=a=>o.form.itemName=a),placeholder:"如 CPU i9-14900K"},null,8,["modelValue"])]),_:1}),t(p,{label:"分类"},{default:r(()=>[t(f,{modelValue:o.form.category,"onUpdate:modelValue":e[5]||(e[5]=a=>o.form.category=a),placeholder:"如 CPU / 主板 / GPU"},null,8,["modelValue"])]),_:1}),t(p,{label:"价格",prop:"price"},{default:r(()=>[t(V,{modelValue:o.form.price,"onUpdate:modelValue":e[6]||(e[6]=a=>o.form.price=a),min:0,step:50,"controls-position":"right"},null,8,["modelValue"])]),_:1}),t(p,{label:"备注"},{default:r(()=>[t(f,{modelValue:o.form.remark,"onUpdate:modelValue":e[7]||(e[7]=a=>o.form.remark=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(U,{modelValue:n.visible,"onUpdate:modelValue":e[15]||(e[15]=a=>n.visible=a),title:"批量录入",width:"560px"},{footer:r(()=>[t(s,{onClick:e[14]||(e[14]=a=>n.visible=!1)},{default:r(()=>[...e[25]||(e[25]=[d("取消",-1)])]),_:1}),t(s,{type:"primary",loading:n.loading,onClick:te},{default:r(()=>[...e[26]||(e[26]=[d("导入",-1)])]),_:1},8,["loading"])]),default:r(()=>[e[27]||(e[27]=g("p",{class:"muted",style:{"margin-bottom":"12px"}},[d(" 每行格式："),g("code",null,"日期, 硬件名称, 分类, 价格, 备注(可选)")],-1)),g("div",Ve,[t(w,{modelValue:n.form.priceDate,"onUpdate:modelValue":e[10]||(e[10]=a=>n.form.priceDate=a),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期"},null,8,["modelValue"]),t(f,{modelValue:n.form.category,"onUpdate:modelValue":e[11]||(e[11]=a=>n.form.category=a),placeholder:"统一分类 (可选)",clearable:""},null,8,["modelValue"]),t(V,{modelValue:n.form.price,"onUpdate:modelValue":e[12]||(e[12]=a=>n.form.price=a),min:0,step:50,placeholder:"统一价格 (可选)"},null,8,["modelValue"])]),t(f,{modelValue:n.raw,"onUpdate:modelValue":e[13]||(e[13]=a=>n.raw=a),type:"textarea",rows:8,placeholder:"2024-06-01,RTX 4090,GPU,12999,京东现货"},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}}),ke=ue(De,[["__scopeId","data-v-a59a8839"]]);export{ke as default};

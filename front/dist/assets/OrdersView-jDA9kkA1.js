import{f as Le,i as $e,u as qe,a as Pe,b as Je,c as He,d as Ke,s as Ze}from"./orders-BUvGxiaE.js";import{d as Ge,a as W,u as Qe,j as h,r as g,k as We,c as N,e as f,m as b,n as D,b as t,w as o,g as p,f as v,F as R,s as F,v as Xe,x as ea,t as x,p as aa,E as S,o as c,_ as la}from"./index-D4luNJRO.js";const ta={class:"page"},oa={class:"page-header"},na={key:0,class:"actions"},ra={class:"user-search-actions"},sa={class:"settle-bar"},ua={class:"batch-grid"},da={class:"quick-tools"},ia={class:"quick-filter-row"},ma={class:"quick-filter-row"},ca={key:0,class:"amount-cell"},pa={key:1},X="user-order-history",fa=Ge({__name:"OrdersView",setup(ga){const O=[{label:"未打款",value:"UNPAID",tag:"warning"},{label:"未收货",value:"NOT_RECEIVED",tag:"info"},{label:"已打款",value:"PAID",tag:"success"}],r=W({dateRange:[],category:"",status:"",keyword:"",page:1,size:20}),re=Qe(),d=h(()=>{var a;return((a=re.user)==null?void 0:a.role)==="ADMIN"}),L=g([]),_=g([]),ee=g(0),$=g(!1),q=g(""),A=g(!1),P=h(()=>d.value?L.value:_.value),se=h(()=>d.value?$.value:A.value),U=g(""),w=g(""),T=g([]),ue=h(()=>{const a=new Map;return P.value.forEach(e=>{e.sn&&a.set(e.sn,(a.get(e.sn)??0)+1)}),new Set(Array.from(a.entries()).filter(([,e])=>e>1).map(([e])=>e))}),de=h(()=>P.value.filter(a=>{const e=!U.value||a.status===U.value,n=a.category&&a.category.trim().length>0?a.category:"未分配",i=!w.value||n===w.value;return e&&i})),ie=h(()=>T.value.map(a=>({name:a.category||"未分配",count:a.count}))),me=a=>a?ue.value.has(a):!1,Y=g(""),B=g(null),J=g(!1),I=g(!1),H=g(!1),K=g(),y=W({orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",currency:"CNY",orderTime:void 0}),ce={trackingNumber:[{required:!0,message:"请输入单号",trigger:"blur"}],sn:[{required:!0,message:"请输入 SN",trigger:"blur"}]},ae=g(),s=W({visible:!1,loading:!1,targetId:0,form:{trackingNumber:"",model:"",sn:"",amount:0,status:"",remark:""}}),le=a=>{const e=O.find(n=>n.value===a);return e?e.label:"未知状态"},pe=a=>{const e=O.find(n=>n.value===a);return(e==null?void 0:e.tag)??"info"},fe=a=>a==null?"-":`￥${a.toFixed(2)}`,te=async a=>{U.value=U.value===a?"":a,d.value&&(r.status=U.value,r.page=1,await C())},oe=async a=>{w.value=w.value===a?"":a,d.value&&(r.category=w.value,r.page=1,await C())},ge=h(()=>{const a={page:r.page,size:r.size,keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a}),ve=()=>{const a={keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a},C=async()=>{if(d.value){$.value=!0;try{const a=await Le(ge.value);L.value=a.records,ee.value=a.total,await z()}finally{$.value=!1}}},ye=()=>{r.page=1,C()},be=a=>{r.size=a,r.page=1,C()},ke=a=>{r.page=a,C()},Ve=()=>{r.dateRange=[],r.category="",r.status="",r.keyword="",r.page=1,U.value="",w.value="",C()},we=()=>{var a;d.value&&((a=ae.value)==null||a.click())},_e=async a=>{var i;if(!d.value)return;const e=a.target,n=(i=e.files)==null?void 0:i[0];if(n)try{await $e(n),S.success("导入成功"),C()}finally{e.value=""}},Ce=async()=>{if(!d.value)return;const a=Y.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(a.length===0){S.warning("请先输入单号");return}J.value=!0;try{await He({trackingNumbers:a,manualAmount:B.value??void 0}),S.success("批量处理完成"),Y.value="",B.value=null,C()}finally{J.value=!1}},Ne=()=>{d.value&&(I.value=!0)},Se=a=>{d.value&&(s.targetId=a.id,s.form.trackingNumber=a.trackingNumber,s.form.model=a.model??"",s.form.sn=a.sn??"",s.form.amount=a.amount??0,s.form.status=a.status??"",s.form.remark=a.remark??"",s.visible=!0)},Ue=async()=>{if(!(!d.value||!K.value||!await K.value.validate().catch(()=>!1))){H.value=!0;try{const e=Object.entries(y).reduce((n,[i,u])=>(u!==""&&u!==void 0&&u!==null&&(n[i]=u),n),{});await Ke(e),S.success("新增成功"),I.value=!1,Object.assign(y,{orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",amount:void 0,currency:"CNY",orderTime:void 0}),C()}finally{H.value=!1}}},he=async(a,e)=>{if(d.value)try{await qe(a.id,e),a.status=e,S.success("状态已更新")}catch(n){console.error(n)}},De=a=>a?a.replace("T"," ").replace("Z",""):"-",xe=async(a,e,n)=>{if(!d.value||Number.isNaN(e))return;const i=n??a.amount??0;try{await Pe(a.id,{amount:e}),a.amount=e,a.currency="CNY",S.success("金额已更新")}catch(u){a.amount=i,console.error(u)}},Oe=async()=>{if(s.targetId){s.loading=!0;try{const a={trackingNumber:s.form.trackingNumber,model:s.form.model,sn:s.form.sn,amount:s.form.amount,status:s.form.status,remark:s.form.remark},e=await updateOrder(s.targetId,a),n=L.value.find(i=>i.id===s.targetId);n&&Object.assign(n,e),s.visible=!1,S.success("已更新"),await z()}finally{s.loading=!1}}},z=async()=>{if(d.value)try{const a=ve();T.value=await Je(a)}catch(a){console.error("Failed to load category stats",a)}else{const a=new Map;P.value.forEach(e=>{const n=e.category&&e.category.trim().length>0?e.category:"未分配";a.set(n,(a.get(n)??0)+1)}),T.value=Array.from(a.entries()).map(([e,n])=>({category:e,count:n}))}w.value&&!T.value.some(a=>(a.category||"未分配")===w.value)&&(w.value="")},Re=async()=>{const a=q.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(!a.length){S.warning("请先输入单号");return}A.value=!0;try{const e=await Ze(a);if(!e.length){S.warning("未查询到对应订单");return}const n=new Map;_.value.forEach(i=>{i.trackingNumber&&n.set(i.trackingNumber,i)}),e.forEach(i=>{i.trackingNumber&&n.set(i.trackingNumber,i)}),_.value=Array.from(n.values()),Fe(),await z()}finally{A.value=!1}},Ie=()=>{_.value=[],localStorage.removeItem(X),z()},ze=()=>{if(!_.value.length)return;const e=[["下单日期","运单号","型号","SN","分类","金额","币种","状态","备注","创建人"].join(",")];_.value.forEach(m=>{e.push([m.orderDate??"",m.trackingNumber??"",m.model??"",m.sn??"",m.category??"",m.amount??"",m.currency??"",le(m.status),m.remark??"",m.createdBy??""].map(E=>`"${String(E).replace(/"/g,'""')}"`).join(","))});const n=new Blob([e.join(`
`)],{type:"text/csv;charset=utf-8;"}),i=window.URL.createObjectURL(n),u=document.createElement("a");u.href=i,u.download=`orders-${new Date().toISOString().slice(0,10)}.csv`,u.click(),window.URL.revokeObjectURL(i)};We(d,a=>{a?C():Ee()},{immediate:!0});function Ee(){try{const a=localStorage.getItem(X);a&&(_.value=JSON.parse(a))}catch(a){console.warn("Failed to load cached user orders",a)}z()}function Fe(){try{localStorage.setItem(X,JSON.stringify(_.value))}catch(a){console.warn("Failed to persist user orders",a)}}return(a,e)=>{const n=v("el-button"),i=v("el-date-picker"),u=v("el-form-item"),m=v("el-input"),E=v("el-option"),Z=v("el-select"),G=v("el-form"),M=v("el-card"),Q=v("el-input-number"),j=v("el-check-tag"),k=v("el-table-column"),ne=v("el-tag"),Ae=v("el-table"),Te=v("el-pagination"),Ye=v("el-drawer"),Be=v("el-dialog"),Me=ea("loading");return c(),N("div",ta,[f("div",oa,[e[28]||(e[28]=f("div",null,[f("h2",null,"物流单号"),f("p",{class:"sub"},"管理员可录入与维护，普通用户仅可查询并跟踪状态")],-1)),d.value?(c(),N("div",na,[f("input",{ref_key:"fileInput",ref:ae,type:"file",accept:".xls,.xlsx",hidden:"",onChange:_e},null,544),t(n,{onClick:we},{default:o(()=>[...e[26]||(e[26]=[p("批量导入",-1)])]),_:1}),t(n,{type:"primary",onClick:Ne},{default:o(()=>[...e[27]||(e[27]=[p("新增单号",-1)])]),_:1})])):D("",!0)]),d.value?(c(),b(M,{key:0},{default:o(()=>[t(G,{inline:!0,model:r,class:"filter-form"},{default:o(()=>[t(u,{label:"日期"},{default:o(()=>[t(i,{modelValue:r.dateRange,"onUpdate:modelValue":e[0]||(e[0]=l=>r.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(u,{label:"分类"},{default:o(()=>[t(m,{modelValue:r.category,"onUpdate:modelValue":e[1]||(e[1]=l=>r.category=l),placeholder:"如 手机",clearable:""},null,8,["modelValue"])]),_:1}),t(u,{label:"状态"},{default:o(()=>[t(Z,{modelValue:r.status,"onUpdate:modelValue":e[2]||(e[2]=l=>r.status=l),placeholder:"全部",clearable:"",style:{width:"160px"}},{default:o(()=>[(c(),N(R,null,F(O,l=>t(E,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"关键字"},{default:o(()=>[t(m,{modelValue:r.keyword,"onUpdate:modelValue":e[3]||(e[3]=l=>r.keyword=l),placeholder:"单号/型号/客户"},null,8,["modelValue"])]),_:1}),t(u,null,{default:o(()=>[t(n,{type:"primary",onClick:ye},{default:o(()=>[...e[29]||(e[29]=[p("查询",-1)])]),_:1}),t(n,{onClick:Ve},{default:o(()=>[...e[30]||(e[30]=[p("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})):(c(),b(M,{key:1,class:"user-search-card"},{header:o(()=>[...e[31]||(e[31]=[f("div",{class:"settle-bar"},[f("span",null,"订单状态查询"),f("small",{class:"muted"},"输入单号即可查询是否结账/录入")],-1)])]),default:o(()=>[t(m,{modelValue:q.value,"onUpdate:modelValue":e[4]||(e[4]=l=>q.value=l),type:"textarea",rows:4,placeholder:"支持多个单号，使用换行/逗号/分号分隔"},null,8,["modelValue"]),f("div",ra,[t(n,{type:"primary",loading:A.value,onClick:Re},{default:o(()=>[...e[32]||(e[32]=[p("查询状态",-1)])]),_:1},8,["loading"]),t(n,{text:"",disabled:!_.value.length,onClick:Ie},{default:o(()=>[...e[33]||(e[33]=[p("清空记录",-1)])]),_:1},8,["disabled"]),t(n,{text:"",disabled:!_.value.length,onClick:ze},{default:o(()=>[...e[34]||(e[34]=[p("导出 Excel",-1)])]),_:1},8,["disabled"])])]),_:1})),d.value?(c(),b(M,{key:2,class:"batch-card"},{header:o(()=>[f("div",sa,[e[36]||(e[36]=f("span",null,"批量抓取",-1)),t(n,{type:"success",loading:J.value,onClick:Ce},{default:o(()=>[...e[35]||(e[35]=[p("抓取并保存",-1)])]),_:1},8,["loading"])])]),default:o(()=>[f("div",ua,[t(m,{modelValue:Y.value,"onUpdate:modelValue":e[5]||(e[5]=l=>Y.value=l),type:"textarea",rows:4,placeholder:"每行一个单号"},null,8,["modelValue"]),t(Q,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=l=>B.value=l),min:0,step:10,"controls-position":"right",label:"统一金额 (可选)",placeholder:"统一金额 (可选)"},null,8,["modelValue"])])]),_:1})):D("",!0),f("div",da,[f("div",ia,[e[38]||(e[38]=f("span",{class:"label"},"状态：",-1)),t(j,{checked:U.value==="",onClick:e[7]||(e[7]=l=>te(""))},{default:o(()=>[...e[37]||(e[37]=[p("全部",-1)])]),_:1},8,["checked"]),(c(),N(R,null,F(O,l=>t(j,{key:l.value,checked:U.value===l.value,onClick:V=>te(l.value)},{default:o(()=>[p(x(l.label),1)]),_:2},1032,["checked","onClick"])),64))]),f("div",ma,[e[40]||(e[40]=f("span",{class:"label"},"物流公司：",-1)),t(j,{checked:w.value==="",onClick:e[8]||(e[8]=l=>oe(""))},{default:o(()=>[...e[39]||(e[39]=[p("全部",-1)])]),_:1},8,["checked"]),(c(!0),N(R,null,F(ie.value,l=>(c(),b(j,{key:l.name,checked:w.value===l.name,onClick:V=>oe(l.name)},{default:o(()=>[p(x(l.name)+"（"+x(l.count)+"） ",1)]),_:2},1032,["checked","onClick"]))),128))])]),t(M,{class:"table-card"},{default:o(()=>[Xe((c(),b(Ae,{data:de.value,style:{width:"100%"}},{default:o(()=>[t(k,{prop:"orderDate",label:"下单日期",width:"120"}),t(k,{prop:"orderTime",label:"时间",width:"180"},{default:o(({row:l})=>[p(x(De(l.orderTime)),1)]),_:1}),t(k,{prop:"trackingNumber",label:"运单号",width:"160"}),t(k,{prop:"model",label:"型号"}),t(k,{prop:"sn",label:"SN",width:"180"},{default:o(({row:l})=>[f("span",{class:aa(["sn-text",{"sn-duplicate":me(l.sn)}])},x(l.sn),3)]),_:1}),t(k,{prop:"category",label:"分类",width:"120"}),t(k,{prop:"amount",label:"金额",width:"160"},{default:o(({row:l})=>[d.value?(c(),N("div",ca,[e[41]||(e[41]=f("span",{class:"currency-label"},"￥",-1)),t(Q,{modelValue:l.amount,"onUpdate:modelValue":V=>l.amount=V,min:0,step:10,size:"small","controls-position":"right",onChange:(V,je)=>xe(l,V,je)},null,8,["modelValue","onUpdate:modelValue","onChange"])])):(c(),N(R,{key:1},[p(x(fe(l.amount)),1)],64))]),_:1}),t(k,{prop:"status",label:"状态",width:"160"},{default:o(({row:l})=>[d.value?(c(),b(Z,{key:0,"model-value":l.status,size:"small",placeholder:"状态",onChange:V=>he(l,V)},{default:o(()=>[(c(),N(R,null,F(O,V=>t(E,{key:V.value,label:V.label,value:V.value},null,8,["label","value"])),64))]),_:1},8,["model-value","onChange"])):(c(),b(ne,{key:1,type:pe(l.status)},{default:o(()=>[p(x(le(l.status)),1)]),_:2},1032,["type"]))]),_:1}),d.value?(c(),b(k,{key:0,label:"导入状态",width:"140"},{default:o(({row:l})=>[l.imported?(c(),b(ne,{key:0,type:"success"},{default:o(()=>[...e[42]||(e[42]=[p("已录入系统",-1)])]),_:1})):(c(),N("span",pa,"-"))]),_:1})):D("",!0),t(k,{prop:"remark",label:"备注"}),t(k,{label:"创建人",prop:"createdBy",width:"120"}),d.value?(c(),b(k,{key:1,label:"操作",width:"120"},{default:o(({row:l})=>[t(n,{link:"",type:"primary",onClick:V=>Se(l)},{default:o(()=>[...e[43]||(e[43]=[p("编辑",-1)])]),_:1},8,["onClick"])]),_:1})):D("",!0)]),_:1},8,["data"])),[[Me,se.value]]),d.value?(c(),b(Te,{key:0,"current-page":r.page,"onUpdate:currentPage":e[9]||(e[9]=l=>r.page=l),"page-size":r.size,"onUpdate:pageSize":e[10]||(e[10]=l=>r.size=l),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",total:ee.value,background:"",style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:be,onCurrentChange:ke},null,8,["current-page","page-size","total"])):D("",!0)]),_:1}),d.value?(c(),b(Ye,{key:3,modelValue:I.value,"onUpdate:modelValue":e[17]||(e[17]=l=>I.value=l),title:"新增物流单",size:"30%","close-on-click-modal":!1},{footer:o(()=>[t(n,{onClick:e[16]||(e[16]=l=>I.value=!1)},{default:o(()=>[...e[44]||(e[44]=[p("取消",-1)])]),_:1}),t(n,{type:"primary",loading:H.value,onClick:Ue},{default:o(()=>[...e[45]||(e[45]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(G,{ref_key:"createFormRef",ref:K,model:y,rules:ce,"label-width":"90px"},{default:o(()=>[t(u,{label:"日期",prop:"orderDate"},{default:o(()=>[t(i,{modelValue:y.orderDate,"onUpdate:modelValue":e[11]||(e[11]=l=>y.orderDate=l),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(u,{label:"单号",prop:"trackingNumber"},{default:o(()=>[t(m,{modelValue:y.trackingNumber,"onUpdate:modelValue":e[12]||(e[12]=l=>y.trackingNumber=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"型号"},{default:o(()=>[t(m,{modelValue:y.model,"onUpdate:modelValue":e[13]||(e[13]=l=>y.model=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"SN"},{default:o(()=>[t(m,{modelValue:y.sn,"onUpdate:modelValue":e[14]||(e[14]=l=>y.sn=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"备注"},{default:o(()=>[t(m,{modelValue:y.remark,"onUpdate:modelValue":e[15]||(e[15]=l=>y.remark=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])):D("",!0),d.value?(c(),b(Be,{key:4,modelValue:s.visible,"onUpdate:modelValue":e[25]||(e[25]=l=>s.visible=l),title:"编辑物流单号",width:"520px"},{footer:o(()=>[t(n,{onClick:e[24]||(e[24]=l=>s.visible=!1)},{default:o(()=>[...e[46]||(e[46]=[p("取消",-1)])]),_:1}),t(n,{type:"primary",loading:s.loading,onClick:Oe},{default:o(()=>[...e[47]||(e[47]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(G,{"label-width":"90px"},{default:o(()=>[t(u,{label:"运单号"},{default:o(()=>[t(m,{modelValue:s.form.trackingNumber,"onUpdate:modelValue":e[18]||(e[18]=l=>s.form.trackingNumber=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"型号"},{default:o(()=>[t(m,{modelValue:s.form.model,"onUpdate:modelValue":e[19]||(e[19]=l=>s.form.model=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"SN"},{default:o(()=>[t(m,{modelValue:s.form.sn,"onUpdate:modelValue":e[20]||(e[20]=l=>s.form.sn=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"金额"},{default:o(()=>[t(Q,{modelValue:s.form.amount,"onUpdate:modelValue":e[21]||(e[21]=l=>s.form.amount=l),min:0,step:10},null,8,["modelValue"])]),_:1}),t(u,{label:"状态"},{default:o(()=>[t(Z,{modelValue:s.form.status,"onUpdate:modelValue":e[22]||(e[22]=l=>s.form.status=l),placeholder:"请选择"},{default:o(()=>[(c(),N(R,null,F(O,l=>t(E,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"备注"},{default:o(()=>[t(m,{modelValue:s.form.remark,"onUpdate:modelValue":e[23]||(e[23]=l=>s.form.remark=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):D("",!0)])}}}),ba=la(fa,[["__scopeId","data-v-51a52d69"]]);export{ba as default};

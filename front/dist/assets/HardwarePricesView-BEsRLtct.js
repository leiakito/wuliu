import{d as we,u as De,k as P,r as V,a as Y,n as X,c as v,h as n,b as a,p as D,q as h,w as l,e as _,E as N,o as p,i as f,U as Ne,x as g,J as A,P as E,V as B,t as he,W as Ce,T as Me,_ as Ve}from"./index-DSeUM942.js";import{f as Se,u as $e,c as Fe,i as Ae,d as Ee}from"./hardware-CvdqUYMm.js";const Be={class:"page"},Ie={class:"page-header"},ze={class:"actions"},Te={class:"menu-header"},Pe={class:"muted small"},Ye={class:"menu-item-line"},Ue={class:"name"},He={class:"right"},Oe={key:0,class:"price"},Ke={key:1,class:"price muted"},qe={class:"muted small meta"},Re={class:"row-actions"},Le={class:"upload-left"},Je={class:"file-name"},Ze={class:"muted small"},je={key:0},Xe={key:2,class:"muted small"},Ge={key:1,class:"progress-block"},We={class:"result-list"},Qe={class:"result-main"},et={class:"file-name"},tt={class:"muted small"},st={class:"result-desc"},lt={key:0},at={key:1},rt={class:"muted small"},nt={key:0,class:"error-list"},ot={class:"dialog-footer"},it={class:"muted small"},dt={class:"footer-actions"},G="hardware-price-filters",ut=we({__name:"HardwarePricesView",setup(mt){const W=De();P(()=>{var t;return((t=W.user)==null?void 0:t.role)==="ADMIN"});const S=V(),i=Y({range:[],itemName:""}),C=V(!1),$=V([]),U=V(!1),u=Y({visible:!1,loading:!1,editingId:0,form:{priceDate:"",itemName:"",price:0}}),r=Y({visible:!1,uploading:!1,progress:0,files:[],results:[]}),I=V(),Q={priceDate:[{required:!0,message:"请选择日期",trigger:"change"}],itemName:[{required:!0,message:"请输入名称",trigger:"blur"}],price:[{required:!0,message:"请输入价格",trigger:"change"}]};P(()=>$.value);const H=P(()=>{const t=new Map;for(const m of $.value){const d=m.priceDate&&/^\d{4}-\d{2}-\d{2}$/.test(m.priceDate)?m.priceDate:"未标注日期";t.has(d)||t.set(d,[]),t.get(d).push(m)}const e=Array.from(t.entries()).map(([m,d])=>({date:m,items:d.slice().sort((c,y)=>(c.itemName||"").localeCompare(y.itemName||"","zh-CN"))})),o=m=>/^\d{4}-\d{2}-\d{2}$/.test(m);return e.sort((m,d)=>{const c=o(m.date),y=o(d.date);return c&&y?d.date.localeCompare(m.date):c?-1:y?1:m.date.localeCompare(d.date,"zh-CN")}),e}),O=()=>{const t=new Date,e=new Date;return e.setDate(t.getDate()-6),[z(e),z(t)]},z=t=>{const e=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),m=String(t.getDate()).padStart(2,"0");return`${e}-${o}-${m}`},ee=()=>{try{const t=localStorage.getItem(G);if(!t)return!1;const e=JSON.parse(t);return Array.isArray(e.range)&&e.range.length===2&&(i.range=e.range),typeof e.itemName=="string"&&(i.itemName=e.itemName),!0}catch(t){return console.warn("Failed to load hardware price filters",t),!1}},K=()=>{try{localStorage.setItem(G,JSON.stringify({range:i.range,itemName:i.itemName}))}catch(t){console.warn("Failed to persist hardware price filters",t)}},x=async()=>{U.value=!0;try{const t={};Array.isArray(i.range)&&i.range.length===2&&(t.startDate=i.range[0],t.endDate=i.range[1]),i.itemName&&(t.itemName=i.itemName),$.value=await Se(t)}finally{U.value=!1}},te=()=>{C.value=!0,i.range=O(),i.itemName="",C.value=!1,x()},se=()=>{i.itemName=""},q=t=>{t?(u.editingId=t.id,Object.assign(u.form,{priceDate:t.priceDate,itemName:t.itemName,price:t.price})):(u.editingId=0,Object.assign(u.form,{priceDate:Array.isArray(i.range)&&i.range[1]?i.range[1]:z(new Date),itemName:"",price:0})),u.visible=!0},le=()=>{r.uploading=!1,r.progress=0,r.files=[],r.results=[],S.value&&(S.value.value=""),r.visible=!0},ae=()=>{var t;(t=S.value)==null||t.click()},re=t=>{const e=t.target;e.files&&e.files.length&&(L(e.files),e.value="")},ne=t=>{var e,o;(o=(e=t.dataTransfer)==null?void 0:e.files)!=null&&o.length&&L(t.dataTransfer.files)},oe=async()=>{if(!(!I.value||!await I.value.validate().catch(()=>!1))){u.loading=!0;try{u.editingId?(await $e(u.editingId,u.form),N.success("更新成功")):(await Fe(u.form),N.success("新增成功")),u.visible=!1,x()}finally{u.loading=!1}}},ie=async t=>{await Me.confirm(`确认删除 ${t.itemName} 的报价吗？`,"提示",{type:"warning"}),await Ee(t.id),N.success("已删除"),x()},de=t=>(t??0).toFixed(2),ue=t=>t?t.replace("T"," ").replace("Z","").slice(0,19):"-",me=t=>{const e=t.match(/(20\d{2}-\d{2}-\d{2})/);return e?e[1]:""},R=t=>!t&&t!==0?"-":t<1024?`${t}B`:t<1024*1024?`${(t/1024).toFixed(1)}KB`:`${(t/1024/1024).toFixed(1)}MB`,L=t=>{const o=new Set(r.files.map(c=>`${c.name}-${c.priceDate??""}`)),m=r.files.reduce((c,y)=>c+y.size,0),d=Array.from(t).reduce((c,y)=>c+y.size,0);if(m+d>524288e3){const c=((m+d)/1024/1024).toFixed(1);N.error(`文件总大小不能超过 500MB，当前已选 ${c}MB`);return}Array.from(t).forEach(c=>{const y=me(c.name),M=`${c.name}-${y}`;if(o.has(M))return;o.add(M);const b={uid:Date.now()+Math.random(),file:c,name:c.name,size:c.size,priceDate:y,status:"ready",message:""};/\.(xls|xlsx)$/i.test(c.name)?y||(b.status="error",b.message="文件名需包含日期（yyyy-MM-dd）"):(b.status="error",b.message="仅支持 .xls / .xlsx 文件"),r.files.push(b)}),r.results=[]},ce=t=>{r.files=r.files.filter(e=>e.uid!==t),r.results=[]},pe=async()=>{if(!r.files.length){N.warning("请先选择 Excel 文件");return}if(r.files.filter(e=>e.status==="error"||!e.priceDate).length){N.error("存在未通过校验的文件，请先处理或移除");return}r.uploading=!0,r.progress=8,r.results=[];try{const e=await Ae(r.files.map(d=>d.file),d=>{r.progress=Math.min(98,Math.max(r.progress,d))});r.results=e,r.progress=100;const o=e.some(d=>!d.success),m=o?"部分文件导入失败，请查看结果":"导入完成";o?N.warning(m):N.success(m),x()}finally{r.uploading=!1,setTimeout(()=>{r.progress=0},600)}},J=()=>{C.value||x()};return X(()=>i.range,()=>{K(),J()},{deep:!0}),X(()=>i.itemName,()=>{K(),J()}),(()=>{C.value=!0,ee()||(i.range=O(),i.itemName=""),C.value=!1,x()})(),(t,e)=>{const o=_("el-button"),m=_("el-date-picker"),d=_("el-form-item"),c=_("el-input"),y=_("el-form"),M=_("el-card"),b=_("el-tag"),Z=_("el-menu-item"),fe=_("el-sub-menu"),ge=_("el-menu"),_e=_("el-scrollbar"),ye=_("el-input-number"),j=_("el-dialog"),ve=_("el-icon"),F=_("el-table-column"),ke=_("el-table"),be=_("el-progress"),xe=_("el-alert");return p(),v("div",Be,[n("div",Ie,[e[13]||(e[13]=n("div",null,[n("h2",null,"硬件价格"),n("p",{class:"sub"},"只记录型号、价格与录入人，支持上传 Excel 批量导入")],-1)),n("div",ze,[n("input",{ref_key:"fileInput",ref:S,type:"file",accept:".xls,.xlsx",multiple:"",hidden:"",onChange:re},null,544),a(o,{onClick:le},{default:l(()=>[...e[11]||(e[11]=[f("导入Excel",-1)])]),_:1}),a(o,{type:"primary",onClick:e[0]||(e[0]=s=>q())},{default:l(()=>[...e[12]||(e[12]=[f("新增价格",-1)])]),_:1})])]),a(M,null,{default:l(()=>[a(y,{inline:!0,model:i,class:"filter-form"},{default:l(()=>[a(d,{label:"日期"},{default:l(()=>[a(m,{modelValue:i.range,"onUpdate:modelValue":e[1]||(e[1]=s=>i.range=s),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD","unlink-panels":""},null,8,["modelValue"])]),_:1}),a(d,null,{default:l(()=>[a(o,{type:"primary",onClick:x},{default:l(()=>[...e[14]||(e[14]=[f("查询",-1)])]),_:1}),a(o,{onClick:te},{default:l(()=>[...e[15]||(e[15]=[f("最近 7 天",-1)])]),_:1})]),_:1}),a(d,{label:"型号"},{default:l(()=>[a(c,{modelValue:i.itemName,"onUpdate:modelValue":e[2]||(e[2]=s=>i.itemName=s),placeholder:"输入型号关键字",clearable:"",style:{width:"200px"},onKeyup:Ne(x,["enter"])},null,8,["modelValue"]),a(o,{style:{"margin-left":"8px"},onClick:se},{default:l(()=>[...e[16]||(e[16]=[f("清空",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),H.value.length?(p(),D(M,{key:0,class:"menu-card"},{default:l(()=>[n("div",Te,[e[17]||(e[17]=n("span",{class:"title"},"按日期查看",-1)),n("span",Pe,"共 "+g($.value.length)+" 条",1)]),a(_e,{height:"70vh"},{default:l(()=>[a(ge,{class:"group-menu","unique-opened":!0},{default:l(()=>[(p(!0),v(A,null,E(H.value,(s,w)=>(p(),D(fe,{key:s.date,index:String(w)},{title:l(()=>[n("span",null,g(s.date),1),a(b,{size:"small",style:{"margin-left":"8px"}},{default:l(()=>[f(g(s.items.length),1)]),_:2},1024)]),default:l(()=>[(p(!0),v(A,null,E(s.items,k=>(p(),D(Z,{key:k.id,index:`${w}-${k.id}`},{default:l(()=>[n("div",Ye,[n("span",Ue,g(k.itemName),1),n("span",He,[k.price!==null&&k.price!==void 0?(p(),v("span",Oe,"￥"+g(de(k.price)),1)):(p(),v("span",Ke,"-")),n("span",qe,g(ue(k.createdAt))+" · "+g(k.createdBy),1),n("span",Re,[a(o,{link:"",type:"primary",onClick:B(T=>q(k),["stop"])},{default:l(()=>[...e[18]||(e[18]=[f("编辑",-1)])]),_:1},8,["onClick"]),a(o,{link:"",type:"danger",onClick:B(T=>ie(k),["stop"])},{default:l(()=>[...e[19]||(e[19]=[f("删除",-1)])]),_:1},8,["onClick"])])])])]),_:2},1032,["index"]))),128))]),_:2},1032,["index"]))),128))]),_:1})]),_:1})]),_:1})):h("",!0),a(j,{modelValue:u.visible,"onUpdate:modelValue":e[7]||(e[7]=s=>u.visible=s),title:"硬件价格",width:"520px"},{footer:l(()=>[a(o,{onClick:e[6]||(e[6]=s=>u.visible=!1)},{default:l(()=>[...e[20]||(e[20]=[f("取消",-1)])]),_:1}),a(o,{type:"primary",loading:u.loading,onClick:oe},{default:l(()=>[...e[21]||(e[21]=[f("保存",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(y,{ref_key:"formRef",ref:I,model:u.form,rules:Q,"label-width":"90px"},{default:l(()=>[a(d,{label:"日期",prop:"priceDate"},{default:l(()=>[a(m,{modelValue:u.form.priceDate,"onUpdate:modelValue":e[3]||(e[3]=s=>u.form.priceDate=s),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(d,{label:"硬件名称",prop:"itemName"},{default:l(()=>[a(c,{modelValue:u.form.itemName,"onUpdate:modelValue":e[4]||(e[4]=s=>u.form.itemName=s),placeholder:"如 CPU i9-14900K"},null,8,["modelValue"])]),_:1}),a(d,{label:"价格",prop:"price"},{default:l(()=>[a(ye,{modelValue:u.form.price,"onUpdate:modelValue":e[5]||(e[5]=s=>u.form.price=s),min:0,step:50,"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(j,{modelValue:r.visible,"onUpdate:modelValue":e[10]||(e[10]=s=>r.visible=s),title:"导入Excel",width:"760px"},{footer:l(()=>[n("div",ot,[n("div",it,[f(" 已选 "+g(r.files.length)+" 个文件，总大小 "+g(R(r.files.reduce((s,w)=>s+w.size,0)))+" / 500MB；仅处理文件名格式为 ",1),e[30]||(e[30]=n("code",null,"yyyy-MM-dd.xlsx",-1)),e[31]||(e[31]=f(" 的记录。 ",-1))]),n("div",dt,[a(o,{onClick:e[9]||(e[9]=s=>r.visible=!1),disabled:r.uploading},{default:l(()=>[...e[32]||(e[32]=[f("取消",-1)])]),_:1},8,["disabled"]),a(o,{type:"primary",loading:r.uploading,onClick:pe},{default:l(()=>[...e[33]||(e[33]=[f("开始导入",-1)])]),_:1},8,["loading"])])])]),default:l(()=>[e[34]||(e[34]=n("p",{class:"muted",style:{"margin-bottom":"12px"}},[f(" 支持单个或多个 Excel 文件，文件名需包含日期（yyyy-MM-dd），如 "),n("code",null,"2025-10-10.xlsx"),f("，系统会自动识别并导入。 ")],-1)),n("div",{class:"upload-drop",onClick:ae,onDragover:e[8]||(e[8]=B(()=>{},["prevent"])),onDrop:B(ne,["prevent"])},[n("div",Le,[a(ve,null,{default:l(()=>[a(he(Ce))]),_:1}),e[22]||(e[22]=n("div",null,[n("div",{class:"upload-title"},"拖拽或点击上传"),n("div",{class:"muted"},"可一次选择多个 .xls / .xlsx 文件，自动匹配日期")],-1))]),a(o,null,{default:l(()=>[...e[23]||(e[23]=[f("选择文件",-1)])]),_:1})],32),r.files.length?(p(),D(ke,{key:0,data:r.files,size:"small",class:"file-table"},{default:l(()=>[a(F,{prop:"name",label:"文件名","min-width":"260"},{default:l(({row:s})=>[n("div",Je,g(s.name),1),n("div",Ze,"大小 "+g(R(s.size)),1)]),_:1}),a(F,{prop:"priceDate",label:"识别日期",width:"160"},{default:l(({row:s})=>[s.priceDate?(p(),v("span",je,g(s.priceDate),1)):(p(),D(b,{key:1,type:"danger",size:"small"},{default:l(()=>[...e[24]||(e[24]=[f("未识别",-1)])]),_:1}))]),_:1}),a(F,{label:"状态",width:"160"},{default:l(({row:s})=>[s.status==="ready"?(p(),D(b,{key:0,type:"success",size:"small"},{default:l(()=>[...e[25]||(e[25]=[f("待导入",-1)])]),_:1})):(p(),D(b,{key:1,type:"danger",size:"small"},{default:l(()=>[...e[26]||(e[26]=[f("校验失败",-1)])]),_:1})),s.message?(p(),v("span",Xe,g(s.message),1)):h("",!0)]),_:1}),a(F,{label:"操作",width:"120"},{default:l(({row:s})=>[a(o,{link:"",type:"danger",onClick:w=>ce(s.uid)},{default:l(()=>[...e[27]||(e[27]=[f("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):h("",!0),r.uploading?(p(),v("div",Ge,[a(be,{percentage:r.progress,"stroke-width":12,status:r.progress>=100?"success":void 0},null,8,["percentage","status"]),e[28]||(e[28]=n("div",{class:"muted small"},"文件较大时请耐心等待，上传与解析进度将同步更新。",-1))])):h("",!0),r.results.length?(p(),D(xe,{key:2,type:r.results.some(s=>!s.success)?"warning":"success","show-icon":"",closable:!1,class:"result-alert"},{title:l(()=>[...e[29]||(e[29]=[f("导入结果",-1)])]),default:l(()=>[n("div",We,[(p(!0),v(A,null,E(r.results,s=>{var w;return p(),v("div",{key:s.fileName,class:"result-item"},[n("div",Qe,[n("span",et,g(s.fileName),1),a(b,{type:s.success?"success":"danger",size:"small"},{default:l(()=>[f(g(s.success?"成功":"失败"),1)]),_:2},1032,["type"]),n("span",tt,g(s.priceDate||"未识别日期"),1)]),n("div",st,[s.success?(p(),v("span",lt,"导入 "+g(s.successCount??0)+" 条，跳过 "+g(s.skippedCount??0)+" 条",1)):(p(),v("span",at,g(s.message),1)),n("span",rt,"耗时 "+g(Math.round((s.durationMillis??0)/1e3))+"s",1)]),(w=s.errors)!=null&&w.length?(p(),v("ul",nt,[(p(!0),v(A,null,E(s.errors,(k,T)=>(p(),v("li",{key:T},g(k),1))),128))])):h("",!0)])}),128))])]),_:1},8,["type"])):h("",!0)]),_:1},8,["modelValue"])])}}}),gt=Ve(ut,[["__scopeId","data-v-b662c342"]]);export{gt as default};

import{d as De,u as we,k as Y,r as V,a as T,n as j,c as _,h as n,b as a,p as x,q as N,w as l,e as g,o as c,i as p,V as Ne,x as f,J as S,P as E,U as A,t as he,W as Ce,E as D,T as Ve,_ as Me}from"./index-DVwYDEL5.js";import{f as $e,u as Fe,c as Se,i as Ee,d as Ae}from"./hardware-DBru1c0w.js";const Ie={class:"page"},Be={class:"page-header"},Pe={class:"actions"},Ye={class:"menu-header"},Te={class:"muted small"},Ue={class:"menu-item-line"},ze={class:"name"},He={class:"right"},Ke={key:0,class:"price"},qe={key:1,class:"price muted"},Oe={class:"muted small meta"},Re={class:"row-actions"},Je={class:"upload-left"},Le={class:"file-name"},je={class:"muted small"},Ge={key:0},We={key:2,class:"muted small"},Ze={key:1,class:"progress-block"},Qe={class:"result-list"},Xe={class:"result-main"},et={class:"file-name"},tt={class:"muted small"},st={class:"result-desc"},lt={key:0},at={key:1},rt={class:"muted small"},nt={key:0,class:"error-list"},ot={class:"dialog-footer"},it={class:"muted small"},dt={class:"footer-actions"},G="hardware-price-filters",ut=De({__name:"HardwarePricesView",setup(mt){const W=we();Y(()=>{var t;return((t=W.user)==null?void 0:t.role)==="ADMIN"});const M=V(),i=T({range:[],itemName:""}),h=V(!1),$=V([]),U=V(!1),m=T({visible:!1,loading:!1,editingId:0,form:{priceDate:"",itemName:"",price:0}}),r=T({visible:!1,uploading:!1,progress:0,files:[],results:[]}),I=V(),Z={priceDate:[{required:!0,message:"请选择日期",trigger:"change"}],itemName:[{required:!0,message:"请输入名称",trigger:"blur"}],price:[{required:!0,message:"请输入价格",trigger:"change"}]};Y(()=>$.value);const z=Y(()=>{const t=new Map;for(const u of $.value){const d=u.priceDate&&/^\d{4}-\d{2}-\d{2}$/.test(u.priceDate)?u.priceDate:"未标注日期";t.has(d)||t.set(d,[]),t.get(d).push(u)}const e=Array.from(t.entries()).map(([u,d])=>({date:u,items:d.slice().sort((y,b)=>(y.itemName||"").localeCompare(b.itemName||"","zh-CN"))})),o=u=>/^\d{4}-\d{2}-\d{2}$/.test(u);return e.sort((u,d)=>{const y=o(u.date),b=o(d.date);return y&&b?d.date.localeCompare(u.date):y?-1:b?1:u.date.localeCompare(d.date,"zh-CN")}),e}),H=()=>{const t=new Date,e=new Date;return e.setDate(t.getDate()-6),[B(e),B(t)]},B=t=>{const e=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0");return`${e}-${o}-${u}`},Q=()=>{try{const t=localStorage.getItem(G);if(!t)return!1;const e=JSON.parse(t);return Array.isArray(e.range)&&e.range.length===2&&(i.range=e.range),typeof e.itemName=="string"&&(i.itemName=e.itemName),!0}catch(t){return console.warn("Failed to load hardware price filters",t),!1}},K=()=>{try{localStorage.setItem(G,JSON.stringify({range:i.range,itemName:i.itemName}))}catch(t){console.warn("Failed to persist hardware price filters",t)}},k=async()=>{U.value=!0;try{const t={};Array.isArray(i.range)&&i.range.length===2&&(t.startDate=i.range[0],t.endDate=i.range[1]),i.itemName&&(t.itemName=i.itemName),$.value=await $e(t)}finally{U.value=!1}},X=()=>{h.value=!0,i.range=H(),i.itemName="",h.value=!1,k()},ee=()=>{i.itemName=""},q=t=>{t?(m.editingId=t.id,Object.assign(m.form,{priceDate:t.priceDate,itemName:t.itemName,price:t.price})):(m.editingId=0,Object.assign(m.form,{priceDate:Array.isArray(i.range)&&i.range[1]?i.range[1]:B(new Date),itemName:"",price:0})),m.visible=!0},te=()=>{r.uploading=!1,r.progress=0,r.files=[],r.results=[],M.value&&(M.value.value=""),r.visible=!0},se=()=>{var t;(t=M.value)==null||t.click()},le=t=>{const e=t.target;e.files&&e.files.length&&(O(e.files),e.value="")},ae=t=>{var e,o;(o=(e=t.dataTransfer)==null?void 0:e.files)!=null&&o.length&&O(t.dataTransfer.files)},re=async()=>{if(!(!I.value||!await I.value.validate().catch(()=>!1))){m.loading=!0;try{m.editingId?(await Fe(m.editingId,m.form),D.success("更新成功")):(await Se(m.form),D.success("新增成功")),m.visible=!1,k()}finally{m.loading=!1}}},ne=async t=>{await Ve.confirm(`确认删除 ${t.itemName} 的报价吗？`,"提示",{type:"warning"}),await Ae(t.id),D.success("已删除"),k()},oe=t=>(t??0).toFixed(2),ie=t=>t?t.replace("T"," ").replace("Z","").slice(0,19):"-",de=t=>{const e=t.match(/(20\d{2}-\d{2}-\d{2})/);return e?e[1]:""},ue=t=>!t&&t!==0?"-":t<1024?`${t}B`:t<1024*1024?`${(t/1024).toFixed(1)}KB`:`${(t/1024/1024).toFixed(1)}MB`,O=t=>{const e=new Set(r.files.map(o=>`${o.name}-${o.priceDate??""}`));Array.from(t).forEach(o=>{const u=de(o.name),d=`${o.name}-${u}`;if(e.has(d))return;e.add(d);const y={uid:Date.now()+Math.random(),file:o,name:o.name,size:o.size,priceDate:u,status:"ready",message:""};/\.(xls|xlsx)$/i.test(o.name)?u||(y.status="error",y.message="文件名需包含日期（yyyy-MM-dd）"):(y.status="error",y.message="仅支持 .xls / .xlsx 文件"),r.files.push(y)}),r.results=[]},me=t=>{r.files=r.files.filter(e=>e.uid!==t),r.results=[]},ce=async()=>{if(!r.files.length){D.warning("请先选择 Excel 文件");return}if(r.files.filter(e=>e.status==="error"||!e.priceDate).length){D.error("存在未通过校验的文件，请先处理或移除");return}r.uploading=!0,r.progress=8,r.results=[];try{const e=await Ee(r.files.map(d=>d.file),d=>{r.progress=Math.min(98,Math.max(r.progress,d))});r.results=e,r.progress=100;const o=e.some(d=>!d.success),u=o?"部分文件导入失败，请查看结果":"导入完成";o?D.warning(u):D.success(u),k()}finally{r.uploading=!1,setTimeout(()=>{r.progress=0},600)}},R=()=>{h.value||k()};return j(()=>i.range,()=>{K(),R()},{deep:!0}),j(()=>i.itemName,()=>{K(),R()}),(()=>{h.value=!0,Q()||(i.range=H(),i.itemName=""),h.value=!1,k()})(),(t,e)=>{const o=g("el-button"),u=g("el-date-picker"),d=g("el-form-item"),y=g("el-input"),b=g("el-form"),J=g("el-card"),C=g("el-tag"),pe=g("el-menu-item"),fe=g("el-sub-menu"),ge=g("el-menu"),_e=g("el-scrollbar"),ye=g("el-input-number"),L=g("el-dialog"),ve=g("el-icon"),F=g("el-table-column"),ke=g("el-table"),be=g("el-progress"),xe=g("el-alert");return c(),_("div",Ie,[n("div",Be,[e[13]||(e[13]=n("div",null,[n("h2",null,"硬件价格"),n("p",{class:"sub"},"只记录型号、价格与录入人，支持上传 Excel 批量导入")],-1)),n("div",Pe,[n("input",{ref_key:"fileInput",ref:M,type:"file",accept:".xls,.xlsx",multiple:"",hidden:"",onChange:le},null,544),a(o,{onClick:te},{default:l(()=>[...e[11]||(e[11]=[p("导入Excel",-1)])]),_:1}),a(o,{type:"primary",onClick:e[0]||(e[0]=s=>q())},{default:l(()=>[...e[12]||(e[12]=[p("新增价格",-1)])]),_:1})])]),a(J,null,{default:l(()=>[a(b,{inline:!0,model:i,class:"filter-form"},{default:l(()=>[a(d,{label:"日期"},{default:l(()=>[a(u,{modelValue:i.range,"onUpdate:modelValue":e[1]||(e[1]=s=>i.range=s),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD","unlink-panels":""},null,8,["modelValue"])]),_:1}),a(d,null,{default:l(()=>[a(o,{type:"primary",onClick:k},{default:l(()=>[...e[14]||(e[14]=[p("查询",-1)])]),_:1}),a(o,{onClick:X},{default:l(()=>[...e[15]||(e[15]=[p("最近 7 天",-1)])]),_:1})]),_:1}),a(d,{label:"型号"},{default:l(()=>[a(y,{modelValue:i.itemName,"onUpdate:modelValue":e[2]||(e[2]=s=>i.itemName=s),placeholder:"输入型号关键字",clearable:"",style:{width:"200px"},onKeyup:Ne(k,["enter"])},null,8,["modelValue"]),a(o,{style:{"margin-left":"8px"},onClick:ee},{default:l(()=>[...e[16]||(e[16]=[p("清空",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),z.value.length?(c(),x(J,{key:0,class:"menu-card"},{default:l(()=>[n("div",Ye,[e[17]||(e[17]=n("span",{class:"title"},"按日期查看",-1)),n("span",Te,"共 "+f($.value.length)+" 条",1)]),a(_e,{height:"70vh"},{default:l(()=>[a(ge,{class:"group-menu","unique-opened":!0},{default:l(()=>[(c(!0),_(S,null,E(z.value,(s,w)=>(c(),x(fe,{key:s.date,index:String(w)},{title:l(()=>[n("span",null,f(s.date),1),a(C,{size:"small",style:{"margin-left":"8px"}},{default:l(()=>[p(f(s.items.length),1)]),_:2},1024)]),default:l(()=>[(c(!0),_(S,null,E(s.items,v=>(c(),x(pe,{key:v.id,index:`${w}-${v.id}`},{default:l(()=>[n("div",Ue,[n("span",ze,f(v.itemName),1),n("span",He,[v.price!==null&&v.price!==void 0?(c(),_("span",Ke,"￥"+f(oe(v.price)),1)):(c(),_("span",qe,"-")),n("span",Oe,f(ie(v.createdAt))+" · "+f(v.createdBy),1),n("span",Re,[a(o,{link:"",type:"primary",onClick:A(P=>q(v),["stop"])},{default:l(()=>[...e[18]||(e[18]=[p("编辑",-1)])]),_:1},8,["onClick"]),a(o,{link:"",type:"danger",onClick:A(P=>ne(v),["stop"])},{default:l(()=>[...e[19]||(e[19]=[p("删除",-1)])]),_:1},8,["onClick"])])])])]),_:2},1032,["index"]))),128))]),_:2},1032,["index"]))),128))]),_:1})]),_:1})]),_:1})):N("",!0),a(L,{modelValue:m.visible,"onUpdate:modelValue":e[7]||(e[7]=s=>m.visible=s),title:"硬件价格",width:"520px"},{footer:l(()=>[a(o,{onClick:e[6]||(e[6]=s=>m.visible=!1)},{default:l(()=>[...e[20]||(e[20]=[p("取消",-1)])]),_:1}),a(o,{type:"primary",loading:m.loading,onClick:re},{default:l(()=>[...e[21]||(e[21]=[p("保存",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(b,{ref_key:"formRef",ref:I,model:m.form,rules:Z,"label-width":"90px"},{default:l(()=>[a(d,{label:"日期",prop:"priceDate"},{default:l(()=>[a(u,{modelValue:m.form.priceDate,"onUpdate:modelValue":e[3]||(e[3]=s=>m.form.priceDate=s),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(d,{label:"硬件名称",prop:"itemName"},{default:l(()=>[a(y,{modelValue:m.form.itemName,"onUpdate:modelValue":e[4]||(e[4]=s=>m.form.itemName=s),placeholder:"如 CPU i9-14900K"},null,8,["modelValue"])]),_:1}),a(d,{label:"价格",prop:"price"},{default:l(()=>[a(ye,{modelValue:m.form.price,"onUpdate:modelValue":e[5]||(e[5]=s=>m.form.price=s),min:0,step:50,"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(L,{modelValue:r.visible,"onUpdate:modelValue":e[10]||(e[10]=s=>r.visible=s),title:"导入Excel",width:"760px"},{footer:l(()=>[n("div",ot,[n("div",it,[p(" 已选 "+f(r.files.length)+" 个文件；仅处理文件名格式为 ",1),e[30]||(e[30]=n("code",null,"yyyy-MM-dd.xlsx",-1)),e[31]||(e[31]=p(" 的记录。 ",-1))]),n("div",dt,[a(o,{onClick:e[9]||(e[9]=s=>r.visible=!1),disabled:r.uploading},{default:l(()=>[...e[32]||(e[32]=[p("取消",-1)])]),_:1},8,["disabled"]),a(o,{type:"primary",loading:r.uploading,onClick:ce},{default:l(()=>[...e[33]||(e[33]=[p("开始导入",-1)])]),_:1},8,["loading"])])])]),default:l(()=>[e[34]||(e[34]=n("p",{class:"muted",style:{"margin-bottom":"12px"}},[p(" 支持单个或多个 Excel 文件，文件名需包含日期（yyyy-MM-dd），如 "),n("code",null,"2025-10-10.xlsx"),p("，系统会自动识别并导入。 ")],-1)),n("div",{class:"upload-drop",onClick:se,onDragover:e[8]||(e[8]=A(()=>{},["prevent"])),onDrop:A(ae,["prevent"])},[n("div",Je,[a(ve,null,{default:l(()=>[a(he(Ce))]),_:1}),e[22]||(e[22]=n("div",null,[n("div",{class:"upload-title"},"拖拽或点击上传"),n("div",{class:"muted"},"可一次选择多个 .xls / .xlsx 文件，自动匹配日期")],-1))]),a(o,null,{default:l(()=>[...e[23]||(e[23]=[p("选择文件",-1)])]),_:1})],32),r.files.length?(c(),x(ke,{key:0,data:r.files,size:"small",class:"file-table"},{default:l(()=>[a(F,{prop:"name",label:"文件名","min-width":"260"},{default:l(({row:s})=>[n("div",Le,f(s.name),1),n("div",je,"大小 "+f(ue(s.size)),1)]),_:1}),a(F,{prop:"priceDate",label:"识别日期",width:"160"},{default:l(({row:s})=>[s.priceDate?(c(),_("span",Ge,f(s.priceDate),1)):(c(),x(C,{key:1,type:"danger",size:"small"},{default:l(()=>[...e[24]||(e[24]=[p("未识别",-1)])]),_:1}))]),_:1}),a(F,{label:"状态",width:"160"},{default:l(({row:s})=>[s.status==="ready"?(c(),x(C,{key:0,type:"success",size:"small"},{default:l(()=>[...e[25]||(e[25]=[p("待导入",-1)])]),_:1})):(c(),x(C,{key:1,type:"danger",size:"small"},{default:l(()=>[...e[26]||(e[26]=[p("校验失败",-1)])]),_:1})),s.message?(c(),_("span",We,f(s.message),1)):N("",!0)]),_:1}),a(F,{label:"操作",width:"120"},{default:l(({row:s})=>[a(o,{link:"",type:"danger",onClick:w=>me(s.uid)},{default:l(()=>[...e[27]||(e[27]=[p("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):N("",!0),r.uploading?(c(),_("div",Ze,[a(be,{percentage:r.progress,"stroke-width":12,status:r.progress>=100?"success":void 0},null,8,["percentage","status"]),e[28]||(e[28]=n("div",{class:"muted small"},"文件较大时请耐心等待，上传与解析进度将同步更新。",-1))])):N("",!0),r.results.length?(c(),x(xe,{key:2,type:r.results.some(s=>!s.success)?"warning":"success","show-icon":"",closable:!1,class:"result-alert"},{title:l(()=>[...e[29]||(e[29]=[p("导入结果",-1)])]),default:l(()=>[n("div",Qe,[(c(!0),_(S,null,E(r.results,s=>{var w;return c(),_("div",{key:s.fileName,class:"result-item"},[n("div",Xe,[n("span",et,f(s.fileName),1),a(C,{type:s.success?"success":"danger",size:"small"},{default:l(()=>[p(f(s.success?"成功":"失败"),1)]),_:2},1032,["type"]),n("span",tt,f(s.priceDate||"未识别日期"),1)]),n("div",st,[s.success?(c(),_("span",lt,"导入 "+f(s.successCount??0)+" 条，跳过 "+f(s.skippedCount??0)+" 条",1)):(c(),_("span",at,f(s.message),1)),n("span",rt,"耗时 "+f(Math.round((s.durationMillis??0)/1e3))+"s",1)]),(w=s.errors)!=null&&w.length?(c(),_("ul",nt,[(c(!0),_(S,null,E(s.errors,(v,P)=>(c(),_("li",{key:P},f(v),1))),128))])):N("",!0)])}),128))])]),_:1},8,["type"])):N("",!0)]),_:1},8,["modelValue"])])}}}),gt=Me(ut,[["__scopeId","data-v-f48b1df6"]]);export{gt as default};

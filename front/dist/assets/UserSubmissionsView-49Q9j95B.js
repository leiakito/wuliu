import{u as O,w as pe}from"./xlsx-DrgRuPKf.js";import{d as Pe,u as Re,k as Ge,r as V,a as G,n as X,c as S,h as i,b as s,p as T,q as D,w as l,e as w,o as g,i as c,x as k,J,P as j,Q as Je,R as je,s as We,T as fe,E as h,f as qe,_ as Ke}from"./index-DSeUM942.js";import{s as Qe,a as Ye,f as Xe,b as Ze}from"./submissions-C1J54hJM.js";import{s as He}from"./orders-BGoj80BM.js";const et={class:"page submissions-page"},tt={class:"page-header"},at={class:"header-actions"},lt={class:"owner-input-wrapper"},st={key:0},nt={class:"card-header"},rt={key:0,class:"batch-preview"},ot={class:"batch-tags"},it={class:"owner-dialog-header"},ut={class:"owner-grid"},dt=["onClick"],ct={key:0,class:"owner-empty"},Z="submission-owner",ge="submission-invalid-trackings",mt=Pe({__name:"UserSubmissionsView",setup(pt){const W=Re(),ve=qe(),x=Ge(()=>{var t;return((t=W.user)==null?void 0:t.role)==="ADMIN"}),q=[{label:"待处理",value:"PENDING",type:"warning"},{label:"处理中",value:"PROCESSING",type:"info"},{label:"已完成",value:"COMPLETED",type:"success"}],H=t=>{const e=q.find(n=>n.value===t);return e?e.label:"待处理"},be=t=>{const e=q.find(n=>n.value===t);return(e==null?void 0:e.type)??"warning"},ee=[{value:"PAID",label:"已打款",tag:"success"},{value:"UNPAID",label:"未打款",tag:"warning"},{value:"NOT_RECEIVED",label:"未收货",tag:"info"}],te=t=>{var e;return((e=ee.find(n=>n.value===t))==null?void 0:e.label)??"未知"},we=t=>{var e;return((e=ee.find(n=>n.value===t))==null?void 0:e.tag)??"info"},M=V(),B=G({trackingNumber:""}),ke={trackingNumber:[{required:!0,message:"请输入单号",trigger:"blur"}]},K=V(!1),Q=V(!1),Y=V(!1),I=V([]),y=G({page:1,size:10,total:0}),v=G({status:"",trackingNumber:"",username:""}),U=V([]),C=V(""),A=V(!1),z=V(!1),N=V([]),m=G({visible:!1,loading:!1,raw:"",list:[]}),_e=()=>({page:y.page,size:y.size,status:v.status||void 0,trackingNumber:v.trackingNumber?v.trackingNumber.trim():void 0,username:x.value&&v.username?v.username.trim():void 0}),F=async()=>{try{const t=await fetch("/api/user-submissions/owners",{headers:{Authorization:`Bearer ${W.token}`}});if(t.ok){const e=await t.json();U.value=e.data||[]}}catch(t){console.error("加载归属人列表失败",t)}},he=async t=>{try{await fe.confirm(`确认删除归属人 "${t}" 吗？删除后该归属人将从列表中移除，但已关联的单号不受影响。`,"删除确认",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}),(await fetch(`/api/user-submissions/owners/${encodeURIComponent(t)}`,{method:"DELETE",headers:{Authorization:`Bearer ${W.token}`}})).ok?(h.success("删除成功"),C.value===t&&(C.value=""),await F()):h.error("删除失败")}catch(e){e!=="cancel"&&(console.error("删除归属人失败",e),h.error("删除失败"))}},ae=()=>{z.value=!1,A.value=!0,U.value.length||F()},ye=async()=>{try{const{value:t}=await fe.prompt("请输入新归属人名称","添加归属人",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^.+$/,inputErrorMessage:"名称不能为空"});if(t&&t.trim()){const e=t.trim();U.value.includes(e)||U.value.push(e),C.value=e,A.value=!1,h.success("添加成功")}}catch{}},Ce=async t=>{z.value?await he(t):(C.value=t,A.value=!1)},Ne=()=>{const t=localStorage.getItem(Z);t&&(C.value=t)},E=async()=>{Q.value=!0;try{const t=_e(),e=x.value?await Xe(t):await Ze(t);I.value=e.records,y.total=e.total}finally{Q.value=!1}},Ve=async()=>{var u,o,d;if(!M.value)return;try{await M.value.validate()}catch{return}const t=se(B.trackingNumber);if(!t)return;const e=await re([t]);if(e.length){ne(e),h.warning(`单号未在物流单号中：${e.join("、")}`);return}if(I.value.some(b=>{var f;return((f=b.trackingNumber)==null?void 0:f.trim().toUpperCase())===t.toUpperCase()})){h.warning("该单号已提交，请勿重复提交");return}const r={trackingNumber:t,username:((u=C.value)==null?void 0:u.trim())||void 0};K.value=!0;try{await Qe(r),h.success("提交成功"),le(),await E()}catch(b){const f=((d=(o=b==null?void 0:b.response)==null?void 0:o.data)==null?void 0:d.message)??"提交失败，请稍后重试";typeof f=="string"&&f.includes("已提交")?h.warning(f):h.error(f)}finally{K.value=!1}},le=()=>{var t;B.trackingNumber="",(t=M.value)==null||t.clearValidate()},P=()=>{y.page=1,E()},se=t=>(t??"").replace(/^[='‘’“”"`\u200B-\u200F\uFEFF]+/,"").trim().replace(/-+$/,""),ne=t=>{const e=new Set(N.value.map(n=>(n.trackingNumber||"").trim().toUpperCase()));t.forEach(n=>{var o;const r=(n||"").trim();if(!r)return;const u=r.toUpperCase();e.has(u)||(N.value.push({trackingNumber:r,remark:"",ownerUsername:((o=C.value)==null?void 0:o.trim())||""}),e.add(u))}),$()},re=async t=>{const e=t.map(u=>se(u)).filter(Boolean);if(!e.length)return[];const r=(await He(e)).map(u=>u.trackingNumber).filter(Boolean).map(u=>u.trim().toUpperCase());return e.filter(u=>{const o=u.toUpperCase();return r.includes(o)?!1:!r.some(d=>d.startsWith(`${o}-`))})},$=()=>{try{localStorage.setItem(ge,JSON.stringify(N.value))}catch(t){console.warn("Failed to persist invalid trackings",t)}},xe=()=>{try{const t=localStorage.getItem(ge);if(!t)return;const e=JSON.parse(t);if(!Array.isArray(e))return;N.value=e.map(n=>{var r;return typeof n=="string"?{trackingNumber:n,remark:"",ownerUsername:((r=C.value)==null?void 0:r.trim())||""}:{trackingNumber:((n==null?void 0:n.trackingNumber)??"").trim(),remark:((n==null?void 0:n.remark)??"").trim(),ownerUsername:(n==null?void 0:n.ownerUsername)??""}}).filter(n=>!!n.trackingNumber)}catch(t){console.warn("Failed to load invalid trackings",t)}},Se=()=>{v.status="",v.trackingNumber="",v.username="",P()},Ue=t=>{y.page=t,E()},ze=t=>{y.size=t,y.page=1,E()},Te=()=>{m.raw="",m.list=[],m.visible=!0,U.value.length||F()},De=()=>{const t=m.raw??"",e=new Set,n=[];t.split(/\n+/).forEach(u=>{const o=u.replace(/["“”]/g," ").trim();if(!o)return;const d=/[A-Za-z0-9-]{4,}/g,b=o.match(d);if(!b||!b.length)return;let f=b[0].trim();if(!f||(f.endsWith("-")&&(f=f.replace(/-+$/g,"")),f.length<12))return;const R=f.toUpperCase();e.has(R)||(e.add(R),n.push(f))}),m.list=n};X(()=>m.raw,()=>{De()});const Ie=async()=>{var e;if(!m.list.length){h.warning("请先输入单号");return}const t=await re(m.list);if(t.length){ne(t),h.warning(`以下单号未在物流单号中：${t.join("、")}`);return}m.loading=!0;try{const n={trackingNumbers:[...m.list],rawContent:m.raw,username:((e=C.value)==null?void 0:e.trim())||void 0};await Ye(n),h.success("批量提交成功"),m.visible=!1,E()}finally{m.loading=!1}};X(C,t=>{t?localStorage.setItem(Z,t):localStorage.removeItem(Z)});const Ee=()=>{ve.push("/submission-logs")},oe=t=>t?t.replace("T"," ").slice(0,19):"-",ie=t=>t?t.replace("T"," ").slice(0,19):"-",Oe=()=>{if(!I.value.length){h.info("暂无可导出的记录");return}Y.value=!0;try{const t=["下单日期","订单时间","单号","型号","物流公司","归属人","提交人","订单状态","提交状态","提交时间"],e=I.value.map(o=>{const d=o.order;return[(d==null?void 0:d.orderDate)??"-",ie(d==null?void 0:d.orderTime),o.trackingNumber??"-",(d==null?void 0:d.model)??"-",(d==null?void 0:d.category)??"-",o.ownerUsername??"-",o.username??"-",te(d==null?void 0:d.status),H(o.status),oe(o.createdAt)]}),n=[t,...e],r=O.aoa_to_sheet(n);r["!cols"]=[{wch:12},{wch:20},{wch:20},{wch:15},{wch:12},{wch:15},{wch:14},{wch:12},{wch:12},{wch:20}];const u=O.book_new();O.book_append_sheet(u,r,"Submissions"),pe(u,`submissions-${new Date().toISOString().slice(0,10)}.xlsx`)}finally{Y.value=!1}},Be=()=>{if(!N.value.length){h.info("暂无可导出的单号");return}const t=["单号","备注","归属人"],e=N.value.map(o=>[o.trackingNumber??"",o.remark??"",o.ownerUsername??""]),n=[t,...e],r=O.aoa_to_sheet(n);r["!cols"]=[{wch:22},{wch:30},{wch:16}];const u=O.book_new();O.book_append_sheet(u,r,"Invalid Trackings"),pe(u,`未在物流单号中的单号-${new Date().toISOString().slice(0,10)}.xlsx`)},Ae=()=>{N.value=[],$()},$e=t=>{t<0||t>=N.value.length||(N.value.splice(t,1),$())};return X(x,t=>{y.page=1,F(),Ne(),xe(),E()},{immediate:!0}),(t,e)=>{const n=w("el-tag"),r=w("el-button"),u=w("el-input"),o=w("el-form-item"),d=w("el-form"),b=w("el-card"),f=w("el-col"),R=w("el-row"),ue=w("el-option"),de=w("el-select"),_=w("el-table-column"),ce=w("el-table"),Le=w("el-pagination"),Me=w("el-scrollbar"),me=w("el-dialog"),Fe=je("loading");return g(),S("div",et,[i("div",tt,[e[13]||(e[13]=i("div",null,[i("h2",null,"单号提交"),i("p",{class:"sub"},"提交后即可在下方列表中查看处理进度")],-1)),i("div",at,[s(n,{type:"info"},{default:l(()=>[c(k(x.value?"管理员视图":"个人视图"),1)]),_:1}),x.value?(g(),T(r,{key:0,type:"primary",plain:"",onClick:Ee},{default:l(()=>[...e[12]||(e[12]=[c("提交记录",-1)])]),_:1})):D("",!0)])]),s(R,{gutter:16,class:"form-row"},{default:l(()=>[s(f,{xs:24,md:12},{default:l(()=>[s(b,null,{header:l(()=>[...e[14]||(e[14]=[i("div",{class:"card-header"},[i("span",null,"提交单号"),i("small",null,"系统会自动匹配订单信息")],-1)])]),default:l(()=>[s(d,{ref_key:"formRef",ref:M,model:B,rules:ke,"label-width":"90px"},{default:l(()=>[s(o,{label:"单号",prop:"trackingNumber"},{default:l(()=>[s(u,{modelValue:B.trackingNumber,"onUpdate:modelValue":e[0]||(e[0]=a=>B.trackingNumber=a),modelModifiers:{trim:!0},placeholder:"请输入或粘贴物流单号"},null,8,["modelValue"])]),_:1}),s(o,null,{default:l(()=>[s(r,{type:"primary",loading:K.value,onClick:Ve},{default:l(()=>[...e[15]||(e[15]=[c("提交单号",-1)])]),_:1},8,["loading"]),s(r,{onClick:le},{default:l(()=>[...e[16]||(e[16]=[c("清空",-1)])]),_:1}),s(r,{text:"",onClick:Te},{default:l(()=>[...e[17]||(e[17]=[c("批量提交",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),s(f,{xs:24,md:12},{default:l(()=>[s(b,{class:"tips-card"},{header:l(()=>[...e[18]||(e[18]=[i("div",{class:"card-header"},[i("span",null,"操作说明")],-1)])]),default:l(()=>[s(d,{"label-width":"90px",class:"inline-user-form"},{default:l(()=>[s(o,{label:"归属人"},{default:l(()=>[i("div",lt,[s(u,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=a=>C.value=a),readonly:"",placeholder:(x.value,"点击管理按钮选择归属人"),style:{flex:"1"},onClick:ae},null,8,["modelValue","placeholder"]),s(r,{type:"primary",style:{"margin-left":"8px"},onClick:ae},{default:l(()=>[...e[19]||(e[19]=[c("管理",-1)])]),_:1})])]),_:1})]),_:1}),i("ul",null,[e[20]||(e[20]=i("li",null,"请在左侧输入或粘贴物流单号进行提交",-1)),e[21]||(e[21]=i("li",null,"状态默认为「待处理」,确认后会更新状态",-1)),e[22]||(e[22]=i("li",null,"系统会自动关联订单金额、型号等信息",-1)),e[23]||(e[23]=i("li",null,"提交的单号会在物流单号库中查找,找到后会在结账管理界面生成待结账订单",-1)),x.value?(g(),S("li",st,"管理员可使用下方筛选器按归属人或状态查询所有提交")):D("",!0)])]),_:1})]),_:1})]),_:1}),s(b,{class:"filter-card"},{default:l(()=>[s(d,{inline:!0,model:v},{default:l(()=>[s(o,{label:"状态"},{default:l(()=>[s(de,{modelValue:v.status,"onUpdate:modelValue":e[2]||(e[2]=a=>v.status=a),placeholder:"全部",clearable:"",style:{width:"160px"},onChange:P},{default:l(()=>[(g(),S(J,null,j(q,a=>s(ue,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),s(o,{label:"单号"},{default:l(()=>[s(u,{modelValue:v.trackingNumber,"onUpdate:modelValue":e[3]||(e[3]=a=>v.trackingNumber=a),placeholder:"支持模糊搜索",clearable:""},null,8,["modelValue"])]),_:1}),x.value?(g(),T(o,{key:0,label:"归属人"},{default:l(()=>[s(de,{modelValue:v.username,"onUpdate:modelValue":e[4]||(e[4]=a=>v.username=a),placeholder:"全部",clearable:"",filterable:"",style:{width:"200px"},onChange:P},{default:l(()=>[(g(!0),S(J,null,j(U.value,a=>(g(),T(ue,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):D("",!0),s(o,null,{default:l(()=>[s(r,{type:"primary",onClick:P},{default:l(()=>[...e[24]||(e[24]=[c("查询",-1)])]),_:1}),s(r,{onClick:Se},{default:l(()=>[...e[25]||(e[25]=[c("重置",-1)])]),_:1}),s(r,{text:"",loading:Y.value,disabled:!I.value.length,onClick:Oe},{default:l(()=>[...e[26]||(e[26]=[c("导出 Excel",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),s(b,{class:"table-card"},{default:l(()=>[Je((g(),T(ce,{data:I.value,style:{width:"100%"}},{default:l(()=>[s(_,{label:"下单日期",width:"140"},{default:l(({row:a})=>{var p;return[c(k(((p=a.order)==null?void 0:p.orderDate)??"-"),1)]}),_:1}),s(_,{label:"订单时间",width:"180"},{default:l(({row:a})=>{var p;return[c(k(ie((p=a.order)==null?void 0:p.orderTime)),1)]}),_:1}),s(_,{prop:"trackingNumber",label:"单号","min-width":"160"}),s(_,{label:"型号","min-width":"160"},{default:l(({row:a})=>{var p;return[c(k(((p=a.order)==null?void 0:p.model)??"-"),1)]}),_:1}),s(_,{label:"物流公司",width:"120"},{default:l(({row:a})=>{var p;return[c(k(((p=a.order)==null?void 0:p.category)??"-"),1)]}),_:1}),x.value?(g(),T(_,{key:0,label:"归属人",width:"140"},{default:l(({row:a})=>[c(k(a.ownerUsername||a.username||"-"),1)]),_:1})):D("",!0),s(_,{label:"提交人",width:"140"},{default:l(({row:a})=>[c(k(a.username||"-"),1)]),_:1}),s(_,{label:"订单状态",width:"140"},{default:l(({row:a})=>{var p;return[s(n,{type:we((p=a.order)==null?void 0:p.status)},{default:l(()=>{var L;return[c(k(te((L=a.order)==null?void 0:L.status)),1)]}),_:2},1032,["type"])]}),_:1}),s(_,{prop:"status",label:"提交状态",width:"140"},{default:l(({row:a})=>[s(n,{type:be(a.status)},{default:l(()=>[c(k(H(a.status)),1)]),_:2},1032,["type"])]),_:1}),s(_,{prop:"createdAt",label:"提交时间",width:"180"},{default:l(({row:a})=>[c(k(oe(a.createdAt)),1)]),_:1})]),_:1},8,["data"])),[[Fe,Q.value]]),s(Le,{"current-page":y.page,"onUpdate:currentPage":e[5]||(e[5]=a=>y.page=a),"page-size":y.size,"onUpdate:pageSize":e[6]||(e[6]=a=>y.size=a),total:y.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",background:"",class:"table-pagination",onCurrentChange:Ue,onSizeChange:ze},null,8,["current-page","page-size","total"])]),_:1}),N.value.length?(g(),T(b,{key:0,class:"invalid-card"},{header:l(()=>[i("div",nt,[e[29]||(e[29]=i("span",null,"未在物流单号中的单号",-1)),i("div",null,[s(r,{text:"",size:"small",onClick:Be},{default:l(()=>[...e[27]||(e[27]=[c("导出",-1)])]),_:1}),s(r,{text:"",size:"small",onClick:Ae},{default:l(()=>[...e[28]||(e[28]=[c("清空",-1)])]),_:1})])])]),default:l(()=>[s(ce,{data:N.value,size:"small",style:{width:"100%"}},{default:l(()=>[s(_,{label:"单号","min-width":"240"},{default:l(({row:a,$index:p})=>[s(u,{modelValue:a.trackingNumber,"onUpdate:modelValue":L=>a.trackingNumber=L,modelModifiers:{trim:!0},placeholder:"请输入单号",onChange:$},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(_,{label:"备注","min-width":"200"},{default:l(({row:a})=>[s(u,{modelValue:a.remark,"onUpdate:modelValue":p=>a.remark=p,modelModifiers:{trim:!0},placeholder:"可填写备注",onChange:$},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(_,{label:"归属人",width:"200"},{default:l(({row:a})=>[i("span",null,k(a.ownerUsername||"-"),1)]),_:1}),s(_,{label:"操作",width:"120"},{default:l(({row:a,$index:p})=>[s(r,{text:"",type:"danger",size:"small",onClick:L=>$e(p)},{default:l(()=>[...e[30]||(e[30]=[c("清除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):D("",!0),s(me,{modelValue:m.visible,"onUpdate:modelValue":e[9]||(e[9]=a=>m.visible=a),title:"批量提交单号",width:"520px"},{footer:l(()=>[s(r,{onClick:e[8]||(e[8]=a=>m.visible=!1)},{default:l(()=>[...e[31]||(e[31]=[c("取消",-1)])]),_:1}),s(r,{type:"primary",loading:m.loading,onClick:Ie},{default:l(()=>[...e[32]||(e[32]=[c("提交",-1)])]),_:1},8,["loading"])]),default:l(()=>[e[33]||(e[33]=i("div",{class:"batch-tip"},[i("p",null,"支持一次粘贴多个单号，系统会自动提取每行中的第一个编号。"),i("p",null,"批量提交请确保每个单号单独换行。"),i("p",null,"示例："),i("pre",{class:"batch-example"},`JDX044863610899
343138058920`)],-1)),s(u,{modelValue:m.raw,"onUpdate:modelValue":e[7]||(e[7]=a=>m.raw=a),type:"textarea",rows:8,placeholder:"每行一个单号，可附带备注"},null,8,["modelValue"]),m.list.length?(g(),S("div",rt,[i("span",null,"已识别 "+k(m.list.length)+" 个单号：",1),s(Me,{"max-height":"120"},{default:l(()=>[i("div",ot,[(g(!0),S(J,null,j(m.list,a=>(g(),T(n,{key:a,class:"tag-item"},{default:l(()=>[c(k(a),1)]),_:2},1024))),128))])]),_:1})])):D("",!0)]),_:1},8,["modelValue"]),s(me,{modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=a=>A.value=a),title:"归属人管理",width:"500px"},{default:l(()=>[i("div",it,[s(r,{type:"primary",size:"small",onClick:ye},{default:l(()=>[...e[34]||(e[34]=[c("添加",-1)])]),_:1}),s(r,{type:z.value?"danger":"default",size:"small",onClick:e[10]||(e[10]=a=>z.value=!z.value)},{default:l(()=>[c(k(z.value?"取消删除":"删除"),1)]),_:1},8,["type"])]),i("div",ut,[(g(!0),S(J,null,j(U.value,a=>(g(),S("div",{key:a,class:We(["owner-item",{"owner-item--selected":C.value===a,"owner-item--delete-mode":z.value}]),onClick:p=>Ce(a)},k(a),11,dt))),128))]),U.value.length?D("",!0):(g(),S("div",ct,"暂无归属人，点击添加按钮新建"))]),_:1},8,["modelValue"])])}}}),wt=Ke(mt,[["__scopeId","data-v-a5a04e13"]]);export{wt as default};

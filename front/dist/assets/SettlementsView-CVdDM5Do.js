import{y as h,d as ne,u as oe,j as M,a as P,r as b,c as O,e as k,b as t,m as V,n as B,w as o,g as d,f as r,v as se,x as re,t as v,E as R,o as y,C as de,_ as ie}from"./index-D4luNJRO.js";const ue=i=>{const c=new URLSearchParams;return Object.entries(i).forEach(([_,f])=>{f==null||f===""||(Array.isArray(f)?f.forEach(a=>{a!=null&&a!==""&&c.append(_,String(a))}):c.append(_,String(f)))}),c.toString()},pe=i=>h.get("/settlements",{params:i}),me=(i,c)=>h.put(`/settlements/${i}/confirm`,c),ce=i=>h.delete("/settlements",{data:i}),fe=async i=>await h.get("/settlements/export",{params:i,paramsSerializer:()=>ue(i),responseType:"blob"}),ge={class:"page"},_e={class:"page-header"},be={class:"actions"},ve={key:1},ye=ne({__name:"SettlementsView",setup(i){const c=oe(),_=M(()=>{var l;return((l=c.user)==null?void 0:l.role)==="ADMIN"}),f={PENDING:"待结账",CONFIRMED:"已确认",PAID:"已打款",UNPAID:"未打款",NOT_RECEIVED:"未收货"},a=P({status:"",batch:"",dateRange:[],page:1,size:20}),E=b([]),I=b(0),x=b(!1),S=b(!1),C=b([]),F=b([]),s=P({visible:!1,loading:!1,targetId:0,form:{amount:0,remark:""}}),L=M(()=>{const l={page:a.page,size:a.size,status:a.status||void 0,batch:a.batch||void 0};return a.dateRange.length===2&&(l.startDate=a.dateRange[0],l.endDate=a.dateRange[1]),l}),g=async()=>{x.value=!0;try{const l=await pe(L.value);E.value=l.records,I.value=l.total}finally{x.value=!1}},j=()=>{a.status="",a.batch="",a.dateRange=[],a.page=1,g()},T=l=>{a.size=l,a.page=1,g()},Y=l=>{a.page=l,g()},$=l=>{F.value=l,C.value=l.map(e=>e.id)},G=l=>{s.visible=!0,s.targetId=l.id,s.form.amount=l.amount??0,s.form.remark=l.remark??""},H=async()=>{if(s.targetId){s.loading=!0;try{const l={amount:s.form.amount,remark:s.form.remark};await me(s.targetId,l),R.success("已确认"),s.visible=!1,g()}finally{s.loading=!1}}},q=async()=>{if(_.value){if(!C.value.length){R.info("请选择记录");return}await de.confirm("确认删除选中的结算记录吗？","提示",{type:"warning"}),await ce(C.value),R.success("已删除"),C.value=[],g()}},J=async(l,e="settlements.xlsx")=>{const m=await fe(l),w=new Blob([m.data],{type:"application/octet-stream"}),D=window.URL.createObjectURL(w),p=document.createElement("a");p.href=D,p.download=e,p.click(),window.URL.revokeObjectURL(D)},K=async()=>{S.value=!0;try{const l={status:a.status||void 0,batch:a.batch||void 0};a.dateRange.length===2&&(l.startDate=a.dateRange[0],l.endDate=a.dateRange[1]),await J(l)}finally{S.value=!1}},Q=l=>l?l.toFixed(2):"0.00",W=l=>f[l??""]||"未知";return g(),(l,e)=>{const m=r("el-button"),w=r("el-option"),D=r("el-select"),p=r("el-form-item"),N=r("el-input"),X=r("el-date-picker"),z=r("el-form"),U=r("el-card"),u=r("el-table-column"),A=r("el-tag"),Z=r("el-table"),ee=r("el-pagination"),te=r("el-input-number"),ae=r("el-dialog"),le=re("loading");return y(),O("div",ge,[k("div",_e,[e[11]||(e[11]=k("div",null,[k("h2",null,"结账管理"),k("p",{class:"sub"},"生成、确认与导出待结账记录")],-1)),k("div",be,[t(m,{onClick:K,loading:S.value},{default:o(()=>[...e[9]||(e[9]=[d("导出 Excel",-1)])]),_:1},8,["loading"]),_.value?(y(),V(m,{key:0,type:"danger",plain:"",disabled:!C.value.length,onClick:q},{default:o(()=>[...e[10]||(e[10]=[d(" 删除所选 ",-1)])]),_:1},8,["disabled"])):B("",!0)])]),t(U,null,{default:o(()=>[t(z,{inline:!0,model:a,class:"filter-form"},{default:o(()=>[t(p,{label:"状态"},{default:o(()=>[t(D,{modelValue:a.status,"onUpdate:modelValue":e[0]||(e[0]=n=>a.status=n),clearable:"",placeholder:"全部",style:{width:"160px"}},{default:o(()=>[t(w,{label:"待结账",value:"PENDING"}),t(w,{label:"已确认",value:"CONFIRMED"})]),_:1},8,["modelValue"])]),_:1}),t(p,{label:"批次号"},{default:o(()=>[t(N,{modelValue:a.batch,"onUpdate:modelValue":e[1]||(e[1]=n=>a.batch=n),placeholder:"例如 BATCH-20250118",clearable:""},null,8,["modelValue"])]),_:1}),t(p,{label:"日期"},{default:o(()=>[t(X,{modelValue:a.dateRange,"onUpdate:modelValue":e[2]||(e[2]=n=>a.dateRange=n),type:"daterange","value-format":"YYYY-MM-DD","start-placeholder":"开始","end-placeholder":"结束"},null,8,["modelValue"])]),_:1}),t(p,null,{default:o(()=>[t(m,{type:"primary",onClick:g},{default:o(()=>[...e[12]||(e[12]=[d("查询",-1)])]),_:1}),t(m,{onClick:j},{default:o(()=>[...e[13]||(e[13]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(U,{class:"table-card"},{default:o(()=>[se((y(),V(Z,{data:E.value,height:"520",onSelectionChange:$},{default:o(()=>[t(u,{type:"selection",width:"48"}),t(u,{prop:"trackingNumber",label:"单号",width:"160"}),t(u,{prop:"model",label:"型号",width:"160"},{default:o(({row:n})=>[d(v(n.model||"-"),1)]),_:1}),t(u,{prop:"amount",label:"金额",width:"120"},{default:o(({row:n})=>[d(v(n.amount??"-")+" "+v(n.currency),1)]),_:1}),t(u,{prop:"orderAmount",label:"订单金额",width:"140"},{default:o(({row:n})=>[d("￥"+v(Q(n.orderAmount)),1)]),_:1}),t(u,{prop:"status",label:"状态",width:"120"},{default:o(({row:n})=>[t(A,{type:n.status==="CONFIRMED"?"success":"warning"},{default:o(()=>[d(v(n.status==="CONFIRMED"?"已确认":"待结账"),1)]),_:2},1032,["type"])]),_:1}),t(u,{prop:"orderStatus",label:"订单状态",width:"140"},{default:o(({row:n})=>[n.orderStatus?(y(),V(A,{key:0,type:n.orderStatus==="PAID"?"success":"info"},{default:o(()=>[d(v(W(n.orderStatus)),1)]),_:2},1032,["type"])):(y(),O("span",ve,"-"))]),_:1}),t(u,{prop:"settleBatch",label:"批次",width:"180"}),t(u,{prop:"payableAt",label:"应付日期",width:"140"}),t(u,{prop:"remark",label:"备注"}),t(u,{label:"操作",width:"160"},{default:o(({row:n})=>[_.value&&n.status!=="CONFIRMED"?(y(),V(m,{key:0,link:"",type:"primary",onClick:Ce=>G(n)},{default:o(()=>[...e[14]||(e[14]=[d(" 确认 ",-1)])]),_:1},8,["onClick"])):B("",!0)]),_:1})]),_:1},8,["data"])),[[le,x.value]]),t(ee,{"current-page":a.page,"onUpdate:currentPage":e[3]||(e[3]=n=>a.page=n),"page-size":a.size,"onUpdate:pageSize":e[4]||(e[4]=n=>a.size=n),total:I.value,layout:"total, sizes, prev, pager, next","page-sizes":[10,20,50],style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:T,onCurrentChange:Y},null,8,["current-page","page-size","total"])]),_:1}),t(ae,{modelValue:s.visible,"onUpdate:modelValue":e[8]||(e[8]=n=>s.visible=n),title:"确认结账",width:"480px"},{footer:o(()=>[t(m,{onClick:e[7]||(e[7]=n=>s.visible=!1)},{default:o(()=>[...e[15]||(e[15]=[d("取消",-1)])]),_:1}),t(m,{type:"primary",loading:s.loading,onClick:H},{default:o(()=>[...e[16]||(e[16]=[d("确认",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(z,{"label-width":"100px"},{default:o(()=>[t(p,{label:"金额"},{default:o(()=>[t(te,{modelValue:s.form.amount,"onUpdate:modelValue":e[5]||(e[5]=n=>s.form.amount=n),min:0,step:10},null,8,["modelValue"])]),_:1}),t(p,{label:"备注"},{default:o(()=>[t(N,{modelValue:s.form.remark,"onUpdate:modelValue":e[6]||(e[6]=n=>s.form.remark=n),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),we=ie(ye,[["__scopeId","data-v-7500a7d5"]]);export{we as default};

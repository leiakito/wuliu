import{f as He,i as Ze,u as Ge,a as Qe,b as We,c as ea,d as aa,s as ta}from"./orders-BESWASbh.js";import{d as la,a as Q,u as oa,j as h,r as g,k as na,c as N,e as f,m as b,n as D,b as l,w as o,g as p,f as v,F as x,s as z,v as ra,x as sa,t as I,p as ua,E as S,o as m,_ as da}from"./index-xnLysfLr.js";const ia={class:"page"},ma={class:"page-header"},ca={key:0,class:"actions"},pa={class:"user-search-actions"},fa={class:"settle-bar"},ga={class:"batch-grid"},va={class:"quick-tools"},ya={class:"quick-filter-row"},ba={class:"quick-filter-row"},ka={key:0,class:"amount-cell"},Va={key:1},W="user-order-history",_a=la({__name:"OrdersView",setup(wa){const E=[{label:"未打款",value:"UNPAID",tag:"warning"},{label:"未收货",value:"NOT_RECEIVED",tag:"info"},{label:"已打款",value:"PAID",tag:"success"}],r=Q({dateRange:[],category:"",status:"",keyword:"",page:1,size:20}),ue=/^[='‘’“”"`\u200B-\u200F\uFEFF]+/,de=/^[='‘’“”"`\u200B-\u200F\uFEFF]+/gm,ee=a=>a?a.replace(ue,"").trim():"",ie=a=>a?a.replace(de,""):"",me=oa(),d=h(()=>{var a;return((a=me.user)==null?void 0:a.role)==="ADMIN"}),P=g([]),w=g([]),ae=g(0),$=g(!1),T=g(""),A=g(!1),q=h(()=>d.value?P.value:w.value),ce=h(()=>d.value?$.value:A.value),U=g(""),_=g(""),L=g([]),pe=h(()=>{const a=new Map;return q.value.forEach(e=>{e.sn&&a.set(e.sn,(a.get(e.sn)??0)+1)}),new Set(Array.from(a.entries()).filter(([,e])=>e>1).map(([e])=>e))}),fe=h(()=>q.value.filter(a=>{const e=!U.value||a.status===U.value,n=a.category&&a.category.trim().length>0?a.category:"未分配",c=!_.value||n===_.value;return e&&c})),ge=h(()=>L.value.map(a=>({name:a.category||"未分配",count:a.count}))),ve=a=>a?pe.value.has(a):!1,B=g(""),M=g(null),X=g(!1),R=g(!1),K=g(!1),J=g(),y=Q({orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",currency:"CNY",orderTime:void 0}),ye={trackingNumber:[{required:!0,message:"请输入单号",trigger:"blur"}],sn:[{required:!0,message:"请输入 SN",trigger:"blur"}]},te=g(),s=Q({visible:!1,loading:!1,targetId:0,form:{trackingNumber:"",model:"",sn:"",amount:0,status:"",remark:""}}),le=a=>{const e=E.find(n=>n.value===a);return e?e.label:"未知状态"},be=a=>{const e=E.find(n=>n.value===a);return(e==null?void 0:e.tag)??"info"},ke=a=>a==null?"-":`￥${a.toFixed(2)}`,oe=async a=>{U.value=U.value===a?"":a,d.value&&(r.status=U.value,r.page=1,await C())},ne=async a=>{_.value=_.value===a?"":a,d.value&&(r.category=_.value,r.page=1,await C())},Ve=h(()=>{const a={page:r.page,size:r.size,keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a}),_e=()=>{const a={keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a},C=async()=>{if(d.value){$.value=!0;try{const a=await He(Ve.value);P.value=a.records,ae.value=a.total,await F()}finally{$.value=!1}}},we=()=>{r.page=1,C()},Ce=a=>{r.keyword=ee(a)},Ne=a=>{T.value=ie(a)},Se=a=>{r.size=a,r.page=1,C()},Ue=a=>{r.page=a,C()},he=()=>{r.dateRange=[],r.category="",r.status="",r.keyword="",r.page=1,U.value="",_.value="",C()},De=()=>{var a;d.value&&((a=te.value)==null||a.click())},Ie=async a=>{var c;if(!d.value)return;const e=a.target,n=(c=e.files)==null?void 0:c[0];if(n)try{await Ze(n),S.success("导入成功"),C()}finally{e.value=""}},Ee=async()=>{if(!d.value)return;const a=B.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(a.length===0){S.warning("请先输入单号");return}X.value=!0;try{await ea({trackingNumbers:a,manualAmount:M.value??void 0}),S.success("批量处理完成"),B.value="",M.value=null,C()}finally{X.value=!1}},xe=()=>{d.value&&(R.value=!0)},Re=a=>{d.value&&(s.targetId=a.id,s.form.trackingNumber=a.trackingNumber,s.form.model=a.model??"",s.form.sn=a.sn??"",s.form.amount=a.amount??0,s.form.status=a.status??"",s.form.remark=a.remark??"",s.visible=!0)},Fe=async()=>{if(!(!d.value||!J.value||!await J.value.validate().catch(()=>!1))){K.value=!0;try{const e=Object.entries(y).reduce((n,[c,u])=>(u!==""&&u!==void 0&&u!==null&&(n[c]=u),n),{});await aa(e),S.success("新增成功"),R.value=!1,Object.assign(y,{orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",amount:void 0,currency:"CNY",orderTime:void 0}),C()}finally{K.value=!1}}},Oe=async(a,e)=>{if(d.value)try{await Ge(a.id,e),a.status=e,S.success("状态已更新")}catch(n){console.error(n)}},ze=a=>a?a.replace("T"," ").replace("Z",""):"-",Te=async(a,e,n)=>{if(!d.value||Number.isNaN(e))return;const c=n??a.amount??0;try{await Qe(a.id,{amount:e}),a.amount=e,a.currency="CNY",S.success("金额已更新")}catch(u){a.amount=c,console.error(u)}},Ae=async()=>{if(s.targetId){s.loading=!0;try{const a={trackingNumber:s.form.trackingNumber,model:s.form.model,sn:s.form.sn,amount:s.form.amount,status:s.form.status,remark:s.form.remark},e=await updateOrder(s.targetId,a),n=P.value.find(c=>c.id===s.targetId);n&&Object.assign(n,e),s.visible=!1,S.success("已更新"),await F()}finally{s.loading=!1}}},F=async()=>{if(d.value)try{const a=_e();L.value=await We(a)}catch(a){console.error("Failed to load category stats",a)}else{const a=new Map;q.value.forEach(e=>{const n=e.category&&e.category.trim().length>0?e.category:"未分配";a.set(n,(a.get(n)??0)+1)}),L.value=Array.from(a.entries()).map(([e,n])=>({category:e,count:n}))}_.value&&!L.value.some(a=>(a.category||"未分配")===_.value)&&(_.value="")},re=a=>a.sn||a.trackingNumber||"",Le=async()=>{const a=T.value.split(/\n|,|;/).map(e=>ee(e)).filter(Boolean);if(!a.length){S.warning("请先输入单号或 SN");return}A.value=!0;try{const e=await ta(a);if(!e.length){S.warning("未查询到对应订单");return}const n=new Map;w.value.forEach(c=>{const u=re(c);u&&n.set(u,c)}),e.forEach(c=>{const u=re(c);u&&n.set(u,c)}),w.value=Array.from(n.values()),je(),await F()}finally{A.value=!1}},Be=()=>{w.value=[],localStorage.removeItem(W),F()},Me=()=>{if(!w.value.length)return;const e=[["下单日期","运单号","型号","SN","分类","金额","币种","状态","备注","创建人"].join(",")];w.value.forEach(i=>{e.push([i.orderDate??"",i.trackingNumber??"",i.model??"",i.sn??"",i.category??"",i.amount??"",i.currency??"",le(i.status),i.remark??"",i.createdBy??""].map(O=>`"${String(O).replace(/"/g,'""')}"`).join(","))});const n=new Blob([e.join(`
`)],{type:"text/csv;charset=utf-8;"}),c=window.URL.createObjectURL(n),u=document.createElement("a");u.href=c,u.download=`orders-${new Date().toISOString().slice(0,10)}.csv`,u.click(),window.URL.revokeObjectURL(c)};na(d,a=>{a?C():Ye()},{immediate:!0});function Ye(){try{const a=localStorage.getItem(W);a&&(w.value=JSON.parse(a))}catch(a){console.warn("Failed to load cached user orders",a)}F()}function je(){try{localStorage.setItem(W,JSON.stringify(w.value))}catch(a){console.warn("Failed to persist user orders",a)}}return(a,e)=>{const n=v("el-button"),c=v("el-date-picker"),u=v("el-form-item"),i=v("el-input"),O=v("el-option"),H=v("el-select"),Z=v("el-form"),Y=v("el-card"),G=v("el-input-number"),j=v("el-check-tag"),k=v("el-table-column"),se=v("el-tag"),Pe=v("el-table"),$e=v("el-pagination"),qe=v("el-drawer"),Xe=v("el-dialog"),Ke=sa("loading");return m(),N("div",ia,[f("div",ma,[e[28]||(e[28]=f("div",null,[f("h2",null,"物流单号"),f("p",{class:"sub"},"管理员可录入与维护，普通用户仅可查询并跟踪状态")],-1)),d.value?(m(),N("div",ca,[f("input",{ref_key:"fileInput",ref:te,type:"file",accept:".xls,.xlsx",hidden:"",onChange:Ie},null,544),l(n,{onClick:De},{default:o(()=>[...e[26]||(e[26]=[p("批量导入",-1)])]),_:1}),l(n,{type:"primary",onClick:xe},{default:o(()=>[...e[27]||(e[27]=[p("新增单号",-1)])]),_:1})])):D("",!0)]),d.value?(m(),b(Y,{key:0},{default:o(()=>[l(Z,{inline:!0,model:r,class:"filter-form"},{default:o(()=>[l(u,{label:"日期"},{default:o(()=>[l(c,{modelValue:r.dateRange,"onUpdate:modelValue":e[0]||(e[0]=t=>r.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),l(u,{label:"分类"},{default:o(()=>[l(i,{modelValue:r.category,"onUpdate:modelValue":e[1]||(e[1]=t=>r.category=t),placeholder:"如 手机",clearable:""},null,8,["modelValue"])]),_:1}),l(u,{label:"状态"},{default:o(()=>[l(H,{modelValue:r.status,"onUpdate:modelValue":e[2]||(e[2]=t=>r.status=t),placeholder:"全部",clearable:"",style:{width:"160px"}},{default:o(()=>[(m(),N(x,null,z(E,t=>l(O,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"关键字"},{default:o(()=>[l(i,{modelValue:r.keyword,"onUpdate:modelValue":e[3]||(e[3]=t=>r.keyword=t),placeholder:"单号/SN/型号",onInput:Ce},null,8,["modelValue"])]),_:1}),l(u,null,{default:o(()=>[l(n,{type:"primary",onClick:we},{default:o(()=>[...e[29]||(e[29]=[p("查询",-1)])]),_:1}),l(n,{onClick:he},{default:o(()=>[...e[30]||(e[30]=[p("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})):(m(),b(Y,{key:1,class:"user-search-card"},{header:o(()=>[...e[31]||(e[31]=[f("div",{class:"settle-bar"},[f("span",null,"订单状态查询"),f("small",{class:"muted"},"输入单号或 SN 即可查询是否结账/录入")],-1)])]),default:o(()=>[l(i,{modelValue:T.value,"onUpdate:modelValue":e[4]||(e[4]=t=>T.value=t),type:"textarea",rows:4,placeholder:"支持多个单号或 SN，使用换行/逗号/分号分隔",onInput:Ne},null,8,["modelValue"]),f("div",pa,[l(n,{type:"primary",loading:A.value,onClick:Le},{default:o(()=>[...e[32]||(e[32]=[p("查询状态",-1)])]),_:1},8,["loading"]),l(n,{text:"",disabled:!w.value.length,onClick:Be},{default:o(()=>[...e[33]||(e[33]=[p("清空记录",-1)])]),_:1},8,["disabled"]),l(n,{text:"",disabled:!w.value.length,onClick:Me},{default:o(()=>[...e[34]||(e[34]=[p("导出 Excel",-1)])]),_:1},8,["disabled"])])]),_:1})),d.value?(m(),b(Y,{key:2,class:"batch-card"},{header:o(()=>[f("div",fa,[e[36]||(e[36]=f("span",null,"批量抓取",-1)),l(n,{type:"success",loading:X.value,onClick:Ee},{default:o(()=>[...e[35]||(e[35]=[p("抓取并保存",-1)])]),_:1},8,["loading"])])]),default:o(()=>[f("div",ga,[l(i,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=t=>B.value=t),type:"textarea",rows:4,placeholder:"每行一个单号"},null,8,["modelValue"]),l(G,{modelValue:M.value,"onUpdate:modelValue":e[6]||(e[6]=t=>M.value=t),min:0,step:10,"controls-position":"right",label:"统一金额 (可选)",placeholder:"统一金额 (可选)"},null,8,["modelValue"])])]),_:1})):D("",!0),f("div",va,[f("div",ya,[e[38]||(e[38]=f("span",{class:"label"},"状态：",-1)),l(j,{checked:U.value==="",onClick:e[7]||(e[7]=t=>oe(""))},{default:o(()=>[...e[37]||(e[37]=[p("全部",-1)])]),_:1},8,["checked"]),(m(),N(x,null,z(E,t=>l(j,{key:t.value,checked:U.value===t.value,onClick:V=>oe(t.value)},{default:o(()=>[p(I(t.label),1)]),_:2},1032,["checked","onClick"])),64))]),f("div",ba,[e[40]||(e[40]=f("span",{class:"label"},"物流公司：",-1)),l(j,{checked:_.value==="",onClick:e[8]||(e[8]=t=>ne(""))},{default:o(()=>[...e[39]||(e[39]=[p("全部",-1)])]),_:1},8,["checked"]),(m(!0),N(x,null,z(ge.value,t=>(m(),b(j,{key:t.name,checked:_.value===t.name,onClick:V=>ne(t.name)},{default:o(()=>[p(I(t.name)+"（"+I(t.count)+"） ",1)]),_:2},1032,["checked","onClick"]))),128))])]),l(Y,{class:"table-card"},{default:o(()=>[ra((m(),b(Pe,{data:fe.value,style:{width:"100%"}},{default:o(()=>[l(k,{prop:"orderDate",label:"下单日期",width:"120"}),l(k,{prop:"orderTime",label:"时间",width:"180"},{default:o(({row:t})=>[p(I(ze(t.orderTime)),1)]),_:1}),l(k,{prop:"trackingNumber",label:"运单号",width:"160"}),l(k,{prop:"model",label:"型号"}),l(k,{prop:"sn",label:"SN",width:"180"},{default:o(({row:t})=>[f("span",{class:ua(["sn-text",{"sn-duplicate":ve(t.sn)}])},I(t.sn),3)]),_:1}),l(k,{prop:"category",label:"分类",width:"120"}),l(k,{prop:"amount",label:"金额",width:"160"},{default:o(({row:t})=>[d.value?(m(),N("div",ka,[e[41]||(e[41]=f("span",{class:"currency-label"},"￥",-1)),l(G,{modelValue:t.amount,"onUpdate:modelValue":V=>t.amount=V,min:0,step:10,size:"small","controls-position":"right",onChange:(V,Je)=>Te(t,V,Je)},null,8,["modelValue","onUpdate:modelValue","onChange"])])):(m(),N(x,{key:1},[p(I(ke(t.amount)),1)],64))]),_:1}),l(k,{prop:"status",label:"状态",width:"160"},{default:o(({row:t})=>[d.value?(m(),b(H,{key:0,"model-value":t.status,size:"small",placeholder:"状态",onChange:V=>Oe(t,V)},{default:o(()=>[(m(),N(x,null,z(E,V=>l(O,{key:V.value,label:V.label,value:V.value},null,8,["label","value"])),64))]),_:1},8,["model-value","onChange"])):(m(),b(se,{key:1,type:be(t.status)},{default:o(()=>[p(I(le(t.status)),1)]),_:2},1032,["type"]))]),_:1}),d.value?(m(),b(k,{key:0,label:"导入状态",width:"140"},{default:o(({row:t})=>[t.imported?(m(),b(se,{key:0,type:"success"},{default:o(()=>[...e[42]||(e[42]=[p("已录入系统",-1)])]),_:1})):(m(),N("span",Va,"-"))]),_:1})):D("",!0),l(k,{prop:"remark",label:"备注"}),l(k,{label:"创建人",prop:"createdBy",width:"120"}),d.value?(m(),b(k,{key:1,label:"操作",width:"120"},{default:o(({row:t})=>[l(n,{link:"",type:"primary",onClick:V=>Re(t)},{default:o(()=>[...e[43]||(e[43]=[p("编辑",-1)])]),_:1},8,["onClick"])]),_:1})):D("",!0)]),_:1},8,["data"])),[[Ke,ce.value]]),d.value?(m(),b($e,{key:0,"current-page":r.page,"onUpdate:currentPage":e[9]||(e[9]=t=>r.page=t),"page-size":r.size,"onUpdate:pageSize":e[10]||(e[10]=t=>r.size=t),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",total:ae.value,background:"",style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:Se,onCurrentChange:Ue},null,8,["current-page","page-size","total"])):D("",!0)]),_:1}),d.value?(m(),b(qe,{key:3,modelValue:R.value,"onUpdate:modelValue":e[17]||(e[17]=t=>R.value=t),title:"新增物流单",size:"30%","close-on-click-modal":!1},{footer:o(()=>[l(n,{onClick:e[16]||(e[16]=t=>R.value=!1)},{default:o(()=>[...e[44]||(e[44]=[p("取消",-1)])]),_:1}),l(n,{type:"primary",loading:K.value,onClick:Fe},{default:o(()=>[...e[45]||(e[45]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[l(Z,{ref_key:"createFormRef",ref:J,model:y,rules:ye,"label-width":"90px"},{default:o(()=>[l(u,{label:"日期",prop:"orderDate"},{default:o(()=>[l(c,{modelValue:y.orderDate,"onUpdate:modelValue":e[11]||(e[11]=t=>y.orderDate=t),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),l(u,{label:"单号",prop:"trackingNumber"},{default:o(()=>[l(i,{modelValue:y.trackingNumber,"onUpdate:modelValue":e[12]||(e[12]=t=>y.trackingNumber=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"型号"},{default:o(()=>[l(i,{modelValue:y.model,"onUpdate:modelValue":e[13]||(e[13]=t=>y.model=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"SN"},{default:o(()=>[l(i,{modelValue:y.sn,"onUpdate:modelValue":e[14]||(e[14]=t=>y.sn=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"备注"},{default:o(()=>[l(i,{modelValue:y.remark,"onUpdate:modelValue":e[15]||(e[15]=t=>y.remark=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])):D("",!0),d.value?(m(),b(Xe,{key:4,modelValue:s.visible,"onUpdate:modelValue":e[25]||(e[25]=t=>s.visible=t),title:"编辑物流单号",width:"520px"},{footer:o(()=>[l(n,{onClick:e[24]||(e[24]=t=>s.visible=!1)},{default:o(()=>[...e[46]||(e[46]=[p("取消",-1)])]),_:1}),l(n,{type:"primary",loading:s.loading,onClick:Ae},{default:o(()=>[...e[47]||(e[47]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[l(Z,{"label-width":"90px"},{default:o(()=>[l(u,{label:"运单号"},{default:o(()=>[l(i,{modelValue:s.form.trackingNumber,"onUpdate:modelValue":e[18]||(e[18]=t=>s.form.trackingNumber=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"型号"},{default:o(()=>[l(i,{modelValue:s.form.model,"onUpdate:modelValue":e[19]||(e[19]=t=>s.form.model=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"SN"},{default:o(()=>[l(i,{modelValue:s.form.sn,"onUpdate:modelValue":e[20]||(e[20]=t=>s.form.sn=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"金额"},{default:o(()=>[l(G,{modelValue:s.form.amount,"onUpdate:modelValue":e[21]||(e[21]=t=>s.form.amount=t),min:0,step:10},null,8,["modelValue"])]),_:1}),l(u,{label:"状态"},{default:o(()=>[l(H,{modelValue:s.form.status,"onUpdate:modelValue":e[22]||(e[22]=t=>s.form.status=t),placeholder:"请选择"},{default:o(()=>[(m(),N(x,null,z(E,t=>l(O,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"备注"},{default:o(()=>[l(i,{modelValue:s.form.remark,"onUpdate:modelValue":e[23]||(e[23]=t=>s.form.remark=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):D("",!0)])}}}),Sa=da(_a,[["__scopeId","data-v-882926c9"]]);export{Sa as default};

import{f as Le,i as $e,a as qe,u as Pe,b as Je,c as He,d as Ke,s as Ze}from"./orders-CTmTAZmG.js";import{d as Ge,a as P,u as Qe,j as h,r as g,k as We,c as N,h as f,m as b,n as D,b as t,w as o,e as v,F as R,s as A,E as U,o as m,i as p,v as Xe,x as ea,t as x,p as aa,_ as la}from"./index-CbheMMSM.js";const ta={class:"page"},oa={class:"page-header"},na={key:0,class:"actions"},ra={class:"user-search-actions"},sa={class:"settle-bar"},ua={class:"batch-grid"},da={class:"quick-tools"},ia={class:"quick-filter-row"},ma={class:"quick-filter-row"},ca={key:0,class:"amount-cell"},pa={key:1},ee="user-order-history",fa=Ge({__name:"OrdersView",setup(ga){const O=[{label:"未打款",value:"UNPAID",tag:"warning"},{label:"未收货",value:"NOT_RECEIVED",tag:"info"},{label:"已打款",value:"PAID",tag:"success"}],r=P({dateRange:[],category:"",status:"",keyword:"",page:1,size:20}),se=Qe(),d=h(()=>{var a;return((a=se.user)==null?void 0:a.role)==="ADMIN"}),T=g([]),_=g([]),ae=g(0),J=g(!1),H=g(""),Y=g(!1),K=h(()=>d.value?T.value:_.value),ue=h(()=>d.value?J.value:Y.value),S=g(""),w=g(""),B=g([]),de=h(()=>{const a=new Map;return K.value.forEach(e=>{e.sn&&a.set(e.sn,(a.get(e.sn)??0)+1)}),new Set(Array.from(a.entries()).filter(([,e])=>e>1).map(([e])=>e))}),ie=h(()=>K.value.filter(a=>{const e=!S.value||a.status===S.value,n=a.category&&a.category.trim().length>0?a.category:"未分配",c=!w.value||n===w.value;return e&&c})),me=h(()=>B.value.map(a=>({name:a.category||"未分配",count:a.count}))),ce=a=>a?de.value.has(a):!1,M=g(""),j=g(null),Z=g(!1),I=g(!1),G=g(!1),Q=g(),y=P({orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",amount:void 0,currency:"CNY",orderTime:void 0}),pe={trackingNumber:[{required:!0,message:"请输入单号",trigger:"blur"}],sn:[{required:!0,message:"请输入 SN",trigger:"blur"}]},le=g(),s=P({visible:!1,loading:!1,targetId:0,form:{trackingNumber:"",model:"",sn:"",amount:0,status:"",remark:""}}),te=a=>{const e=O.find(n=>n.value===a);return e?e.label:"未知状态"},fe=a=>{const e=O.find(n=>n.value===a);return(e==null?void 0:e.tag)??"info"},E=P({}),ge=a=>a==null?"-":`￥${a.toFixed(2)}`,oe=async a=>{S.value=S.value===a?"":a,d.value&&(r.status=S.value,r.page=1,await C())},ne=async a=>{w.value=w.value===a?"":a,d.value&&(r.category=w.value,r.page=1,await C())},ve=h(()=>{const a={page:r.page,size:r.size,keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a}),ye=()=>{const a={keyword:r.keyword||void 0,category:r.category||void 0,status:r.status||void 0};return r.dateRange.length===2&&(a.startDate=r.dateRange[0],a.endDate=r.dateRange[1]),a},C=async()=>{if(d.value){J.value=!0;try{const a=await Le(ve.value);T.value=a.records,ae.value=a.total,T.value.forEach(e=>{E[e.id]=e.amount}),await z()}finally{J.value=!1}}},be=()=>{r.page=1,C()},ke=a=>{r.size=a,r.page=1,C()},Ve=a=>{r.page=a,C()},we=()=>{r.dateRange=[],r.category="",r.status="",r.keyword="",r.page=1,S.value="",w.value="",C()},_e=()=>{var a;d.value&&((a=le.value)==null||a.click())},Ce=async a=>{var c;if(!d.value)return;const e=a.target,n=(c=e.files)==null?void 0:c[0];if(n)try{await $e(n),U.success("导入成功"),C()}finally{e.value=""}},Ne=async()=>{if(!d.value)return;const a=M.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(a.length===0){U.warning("请先输入单号");return}Z.value=!0;try{await He({trackingNumbers:a,manualAmount:j.value??void 0}),U.success("批量处理完成"),M.value="",j.value=null,C()}finally{Z.value=!1}},Ue=()=>{d.value&&(I.value=!0)},Se=a=>{d.value&&(s.targetId=a.id,s.form.trackingNumber=a.trackingNumber,s.form.model=a.model??"",s.form.sn=a.sn??"",s.form.amount=a.amount??0,s.form.status=a.status??"",s.form.remark=a.remark??"",s.visible=!0)},he=async()=>{if(!(!d.value||!Q.value||!await Q.value.validate().catch(()=>!1))){G.value=!0;try{const e=Object.entries(y).reduce((n,[c,u])=>(u!==""&&u!==void 0&&u!==null&&(n[c]=u),n),{});await Ke(e),U.success("新增成功"),I.value=!1,Object.assign(y,{orderDate:"",trackingNumber:"",model:"",sn:"",remark:"",amount:void 0,currency:"CNY",orderTime:void 0}),C()}finally{G.value=!1}}},De=async(a,e)=>{if(d.value)try{await Pe(a.id,e),a.status=e,U.success("状态已更新")}catch(n){console.error(n)}},xe=a=>a?a.replace("T"," ").replace("Z",""):"-",Oe=async(a,e)=>{if(!(!d.value||Number.isNaN(e))){E[a.id]=e;try{await Je(a.id,{amount:e}),a.amount=e,a.currency="CNY",U.success("金额已更新")}catch(n){console.error(n)}}},Re=async()=>{if(s.targetId){s.loading=!0;try{const a={trackingNumber:s.form.trackingNumber,model:s.form.model,sn:s.form.sn,amount:s.form.amount,status:s.form.status,remark:s.form.remark},e=await updateOrder(s.targetId,a),n=T.value.find(c=>c.id===s.targetId);n&&(Object.assign(n,e),E[n.id]=n.amount),s.visible=!1,U.success("已更新"),await z()}finally{s.loading=!1}}},z=async()=>{if(d.value)try{const a=ye();B.value=await qe(a)}catch(a){console.error("Failed to load category stats",a)}else{const a=new Map;K.value.forEach(e=>{const n=e.category&&e.category.trim().length>0?e.category:"未分配";a.set(n,(a.get(n)??0)+1)}),B.value=Array.from(a.entries()).map(([e,n])=>({category:e,count:n}))}w.value&&!B.value.some(a=>(a.category||"未分配")===w.value)&&(w.value="")},Ie=async()=>{const a=H.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(!a.length){U.warning("请先输入单号");return}Y.value=!0;try{const e=await Ze(a);if(!e.length){U.warning("未查询到对应订单");return}const n=new Map;_.value.forEach(c=>{c.trackingNumber&&n.set(c.trackingNumber,c)}),e.forEach(c=>{c.trackingNumber&&n.set(c.trackingNumber,c)}),_.value=Array.from(n.values()),Ae(),await z()}finally{Y.value=!1}},Ee=()=>{_.value=[],localStorage.removeItem(ee),z()},ze=()=>{if(!_.value.length)return;const e=[["下单日期","运单号","型号","SN","分类","金额","币种","状态","备注","创建人"].join(",")];_.value.forEach(i=>{e.push([i.orderDate??"",i.trackingNumber??"",i.model??"",i.sn??"",i.category??"",i.amount??"",i.currency??"",te(i.status),i.remark??"",i.createdBy??""].map(F=>`"${String(F).replace(/"/g,'""')}"`).join(","))});const n=new Blob([e.join(`
`)],{type:"text/csv;charset=utf-8;"}),c=window.URL.createObjectURL(n),u=document.createElement("a");u.href=c,u.download=`orders-${new Date().toISOString().slice(0,10)}.csv`,u.click(),window.URL.revokeObjectURL(c)};We(d,a=>{a?C():Fe()},{immediate:!0});function Fe(){try{const a=localStorage.getItem(ee);a&&(_.value=JSON.parse(a))}catch(a){console.warn("Failed to load cached user orders",a)}z()}function Ae(){try{localStorage.setItem(ee,JSON.stringify(_.value))}catch(a){console.warn("Failed to persist user orders",a)}}return(a,e)=>{const n=v("el-button"),c=v("el-date-picker"),u=v("el-form-item"),i=v("el-input"),F=v("el-option"),W=v("el-select"),X=v("el-form"),L=v("el-card"),$=v("el-input-number"),q=v("el-check-tag"),k=v("el-table-column"),re=v("el-tag"),Te=v("el-table"),Ye=v("el-pagination"),Be=v("el-drawer"),Me=v("el-dialog"),je=ea("loading");return m(),N("div",ta,[f("div",oa,[e[29]||(e[29]=f("div",null,[f("h2",null,"物流单号"),f("p",{class:"sub"},"管理员可录入与维护，普通用户仅可查询并跟踪状态")],-1)),d.value?(m(),N("div",na,[f("input",{ref_key:"fileInput",ref:le,type:"file",accept:".xls,.xlsx",hidden:"",onChange:Ce},null,544),t(n,{onClick:_e},{default:o(()=>[...e[27]||(e[27]=[p("批量导入",-1)])]),_:1}),t(n,{type:"primary",onClick:Ue},{default:o(()=>[...e[28]||(e[28]=[p("新增单号",-1)])]),_:1})])):D("",!0)]),d.value?(m(),b(L,{key:0},{default:o(()=>[t(X,{inline:!0,model:r,class:"filter-form"},{default:o(()=>[t(u,{label:"日期"},{default:o(()=>[t(c,{modelValue:r.dateRange,"onUpdate:modelValue":e[0]||(e[0]=l=>r.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(u,{label:"分类"},{default:o(()=>[t(i,{modelValue:r.category,"onUpdate:modelValue":e[1]||(e[1]=l=>r.category=l),placeholder:"如 手机",clearable:""},null,8,["modelValue"])]),_:1}),t(u,{label:"状态"},{default:o(()=>[t(W,{modelValue:r.status,"onUpdate:modelValue":e[2]||(e[2]=l=>r.status=l),placeholder:"全部",clearable:"",style:{width:"160px"}},{default:o(()=>[(m(),N(R,null,A(O,l=>t(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"关键字"},{default:o(()=>[t(i,{modelValue:r.keyword,"onUpdate:modelValue":e[3]||(e[3]=l=>r.keyword=l),placeholder:"单号/型号/客户"},null,8,["modelValue"])]),_:1}),t(u,null,{default:o(()=>[t(n,{type:"primary",onClick:be},{default:o(()=>[...e[30]||(e[30]=[p("查询",-1)])]),_:1}),t(n,{onClick:we},{default:o(()=>[...e[31]||(e[31]=[p("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})):(m(),b(L,{key:1,class:"user-search-card"},{header:o(()=>[...e[32]||(e[32]=[f("div",{class:"settle-bar"},[f("span",null,"订单状态查询"),f("small",{class:"muted"},"输入单号即可查询是否结账/录入")],-1)])]),default:o(()=>[t(i,{modelValue:H.value,"onUpdate:modelValue":e[4]||(e[4]=l=>H.value=l),type:"textarea",rows:4,placeholder:"支持多个单号，使用换行/逗号/分号分隔"},null,8,["modelValue"]),f("div",ra,[t(n,{type:"primary",loading:Y.value,onClick:Ie},{default:o(()=>[...e[33]||(e[33]=[p("查询状态",-1)])]),_:1},8,["loading"]),t(n,{text:"",disabled:!_.value.length,onClick:Ee},{default:o(()=>[...e[34]||(e[34]=[p("清空记录",-1)])]),_:1},8,["disabled"]),t(n,{text:"",disabled:!_.value.length,onClick:ze},{default:o(()=>[...e[35]||(e[35]=[p("导出 Excel",-1)])]),_:1},8,["disabled"])])]),_:1})),d.value?(m(),b(L,{key:2,class:"batch-card"},{header:o(()=>[f("div",sa,[e[37]||(e[37]=f("span",null,"批量抓取",-1)),t(n,{type:"success",loading:Z.value,onClick:Ne},{default:o(()=>[...e[36]||(e[36]=[p("抓取并保存",-1)])]),_:1},8,["loading"])])]),default:o(()=>[f("div",ua,[t(i,{modelValue:M.value,"onUpdate:modelValue":e[5]||(e[5]=l=>M.value=l),type:"textarea",rows:4,placeholder:"每行一个单号"},null,8,["modelValue"]),t($,{modelValue:j.value,"onUpdate:modelValue":e[6]||(e[6]=l=>j.value=l),min:0,step:10,"controls-position":"right",label:"统一金额 (可选)",placeholder:"统一金额 (可选)"},null,8,["modelValue"])])]),_:1})):D("",!0),f("div",da,[f("div",ia,[e[39]||(e[39]=f("span",{class:"label"},"状态：",-1)),t(q,{checked:S.value==="",onClick:e[7]||(e[7]=l=>oe(""))},{default:o(()=>[...e[38]||(e[38]=[p("全部",-1)])]),_:1},8,["checked"]),(m(),N(R,null,A(O,l=>t(q,{key:l.value,checked:S.value===l.value,onClick:V=>oe(l.value)},{default:o(()=>[p(x(l.label),1)]),_:2},1032,["checked","onClick"])),64))]),f("div",ma,[e[41]||(e[41]=f("span",{class:"label"},"物流公司：",-1)),t(q,{checked:w.value==="",onClick:e[8]||(e[8]=l=>ne(""))},{default:o(()=>[...e[40]||(e[40]=[p("全部",-1)])]),_:1},8,["checked"]),(m(!0),N(R,null,A(me.value,l=>(m(),b(q,{key:l.name,checked:w.value===l.name,onClick:V=>ne(l.name)},{default:o(()=>[p(x(l.name)+"（"+x(l.count)+"） ",1)]),_:2},1032,["checked","onClick"]))),128))])]),t(L,{class:"table-card"},{default:o(()=>[Xe((m(),b(Te,{data:ie.value,style:{width:"100%"}},{default:o(()=>[t(k,{prop:"orderDate",label:"下单日期",width:"120"}),t(k,{prop:"orderTime",label:"时间",width:"180"},{default:o(({row:l})=>[p(x(xe(l.orderTime)),1)]),_:1}),t(k,{prop:"trackingNumber",label:"运单号",width:"160"}),t(k,{prop:"model",label:"型号"}),t(k,{prop:"sn",label:"SN",width:"180"},{default:o(({row:l})=>[f("span",{class:aa(["sn-text",{"sn-duplicate":ce(l.sn)}])},x(l.sn),3)]),_:1}),t(k,{prop:"category",label:"分类",width:"120"}),t(k,{prop:"amount",label:"金额",width:"160"},{default:o(({row:l})=>[d.value?(m(),N("div",ca,[e[42]||(e[42]=f("span",{class:"currency-label"},"￥",-1)),t($,{modelValue:E[l.id],"onUpdate:modelValue":V=>E[l.id]=V,min:0,step:10,size:"small","controls-position":"right",onChange:V=>Oe(l,V)},null,8,["modelValue","onUpdate:modelValue","onChange"])])):(m(),N(R,{key:1},[p(x(ge(l.amount)),1)],64))]),_:1}),t(k,{prop:"status",label:"状态",width:"160"},{default:o(({row:l})=>[d.value?(m(),b(W,{key:0,"model-value":l.status,size:"small",placeholder:"状态",onChange:V=>De(l,V)},{default:o(()=>[(m(),N(R,null,A(O,V=>t(F,{key:V.value,label:V.label,value:V.value},null,8,["label","value"])),64))]),_:1},8,["model-value","onChange"])):(m(),b(re,{key:1,type:fe(l.status)},{default:o(()=>[p(x(te(l.status)),1)]),_:2},1032,["type"]))]),_:1}),d.value?(m(),b(k,{key:0,label:"导入状态",width:"140"},{default:o(({row:l})=>[l.imported?(m(),b(re,{key:0,type:"success"},{default:o(()=>[...e[43]||(e[43]=[p("已录入系统",-1)])]),_:1})):(m(),N("span",pa,"-"))]),_:1})):D("",!0),t(k,{prop:"remark",label:"备注"}),t(k,{label:"创建人",prop:"createdBy",width:"120"}),d.value?(m(),b(k,{key:1,label:"操作",width:"120"},{default:o(({row:l})=>[t(n,{link:"",type:"primary",onClick:V=>Se(l)},{default:o(()=>[...e[44]||(e[44]=[p("编辑",-1)])]),_:1},8,["onClick"])]),_:1})):D("",!0)]),_:1},8,["data"])),[[je,ue.value]]),d.value?(m(),b(Ye,{key:0,"current-page":r.page,"onUpdate:currentPage":e[9]||(e[9]=l=>r.page=l),"page-size":r.size,"onUpdate:pageSize":e[10]||(e[10]=l=>r.size=l),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",total:ae.value,background:"",style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:ke,onCurrentChange:Ve},null,8,["current-page","page-size","total"])):D("",!0)]),_:1}),d.value?(m(),b(Be,{key:3,modelValue:I.value,"onUpdate:modelValue":e[18]||(e[18]=l=>I.value=l),title:"新增物流单",size:"30%","close-on-click-modal":!1},{footer:o(()=>[t(n,{onClick:e[17]||(e[17]=l=>I.value=!1)},{default:o(()=>[...e[45]||(e[45]=[p("取消",-1)])]),_:1}),t(n,{type:"primary",loading:G.value,onClick:he},{default:o(()=>[...e[46]||(e[46]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(X,{ref_key:"createFormRef",ref:Q,model:y,rules:pe,"label-width":"90px"},{default:o(()=>[t(u,{label:"日期",prop:"orderDate"},{default:o(()=>[t(c,{modelValue:y.orderDate,"onUpdate:modelValue":e[11]||(e[11]=l=>y.orderDate=l),type:"date","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(u,{label:"单号",prop:"trackingNumber"},{default:o(()=>[t(i,{modelValue:y.trackingNumber,"onUpdate:modelValue":e[12]||(e[12]=l=>y.trackingNumber=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"型号"},{default:o(()=>[t(i,{modelValue:y.model,"onUpdate:modelValue":e[13]||(e[13]=l=>y.model=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"SN"},{default:o(()=>[t(i,{modelValue:y.sn,"onUpdate:modelValue":e[14]||(e[14]=l=>y.sn=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"金额"},{default:o(()=>[t($,{modelValue:y.amount,"onUpdate:modelValue":e[15]||(e[15]=l=>y.amount=l),min:0,step:10},null,8,["modelValue"])]),_:1}),t(u,{label:"备注"},{default:o(()=>[t(i,{modelValue:y.remark,"onUpdate:modelValue":e[16]||(e[16]=l=>y.remark=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])):D("",!0),d.value?(m(),b(Me,{key:4,modelValue:s.visible,"onUpdate:modelValue":e[26]||(e[26]=l=>s.visible=l),title:"编辑物流单号",width:"520px"},{footer:o(()=>[t(n,{onClick:e[25]||(e[25]=l=>s.visible=!1)},{default:o(()=>[...e[47]||(e[47]=[p("取消",-1)])]),_:1}),t(n,{type:"primary",loading:s.loading,onClick:Re},{default:o(()=>[...e[48]||(e[48]=[p("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(X,{"label-width":"90px"},{default:o(()=>[t(u,{label:"运单号"},{default:o(()=>[t(i,{modelValue:s.form.trackingNumber,"onUpdate:modelValue":e[19]||(e[19]=l=>s.form.trackingNumber=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"型号"},{default:o(()=>[t(i,{modelValue:s.form.model,"onUpdate:modelValue":e[20]||(e[20]=l=>s.form.model=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"SN"},{default:o(()=>[t(i,{modelValue:s.form.sn,"onUpdate:modelValue":e[21]||(e[21]=l=>s.form.sn=l)},null,8,["modelValue"])]),_:1}),t(u,{label:"金额"},{default:o(()=>[t($,{modelValue:s.form.amount,"onUpdate:modelValue":e[22]||(e[22]=l=>s.form.amount=l),min:0,step:10},null,8,["modelValue"])]),_:1}),t(u,{label:"状态"},{default:o(()=>[t(W,{modelValue:s.form.status,"onUpdate:modelValue":e[23]||(e[23]=l=>s.form.status=l),placeholder:"请选择"},{default:o(()=>[(m(),N(R,null,A(O,l=>t(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"备注"},{default:o(()=>[t(i,{modelValue:s.form.remark,"onUpdate:modelValue":e[24]||(e[24]=l=>s.form.remark=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):D("",!0)])}}}),ba=la(fa,[["__scopeId","data-v-d6863b26"]]);export{ba as default};

import{y as x,d as Se,u as xe,j as Z,a as N,r as U,k as O,c as E,e as M,b as l,m as D,n as R,w as a,g as d,f as v,F,s as G,v as Ee,x as Re,t as B,E as _,o as c,C as Be,_ as Ae}from"./index-xnLysfLr.js";const Ie=b=>{const w=new URLSearchParams;return Object.entries(b).forEach(([y,S])=>{S==null||S===""||(Array.isArray(S)?S.forEach(o=>{o!=null&&o!==""&&w.append(y,String(o))}):w.append(y,String(S)))}),w.toString()},Ne=b=>x.get("/settlements",{params:b}),Oe=(b,w)=>x.put(`/settlements/${b}/confirm`,w),Me=b=>x.delete("/settlements",{data:b}),Pe=async b=>await x.get("/settlements/export",{params:b,paramsSerializer:()=>Ie(b),responseType:"blob"}),ze=b=>x.put("/settlements/price-by-model",b),Le=b=>x.put("/settlements/confirm-batch",b),ee=(b,w)=>x.put(`/settlements/${b}/amount`,w),Fe={class:"page"},he={class:"page-header"},$e={class:"actions"},je={key:1},Te=Se({__name:"SettlementsView",setup(b){const w=xe(),y=Z(()=>{var n;return((n=w.user)==null?void 0:n.role)==="ADMIN"}),S={PENDING:"待结账",CONFIRMED:"已确认",PAID:"已打款",UNPAID:"未打款",NOT_RECEIVED:"未收货"},o=N({status:"",batch:"",createdBy:"",submissionUser:"",dateRange:[],page:1,size:20}),h=U([]),H=U(0),$=U(!1),j=U(!1),V=U([]),q=U([]),T=U(!1),J=U([]),K=U([]),Y=U([]),m=N({visible:!1,loading:!1,targetId:0,form:{amount:0,remark:""}}),s=N({visible:!1,loading:!1,form:{model:"",amount:null,status:"",scope:"MODEL"}}),g=N({visible:!1,loading:!1,form:{amount:null,remark:""}}),f=N({visible:!1,loading:!1,targetId:0,form:{amount:0,remark:""}}),te=Z(()=>{var e,r;const n={page:o.page,size:o.size,status:o.status||void 0,batch:o.batch||void 0,createdBy:((e=o.createdBy)==null?void 0:e.trim())||void 0,submissionUser:((r=o.submissionUser)==null?void 0:r.trim())||void 0};return Array.isArray(o.dateRange)&&o.dateRange.length===2&&(n.startDate=o.dateRange[0],n.endDate=o.dateRange[1]),n}),k=async()=>{$.value=!0;try{const n=await Ne(te.value);h.value=n.records,H.value=n.total,le()}finally{$.value=!1}},A=()=>{T.value||(o.page=1,k())},le=()=>{const n=new Set,e=new Set,r=new Set;h.value.forEach(i=>{var p;i.orderCreatedBy&&n.add(i.orderCreatedBy),i.model&&r.add(i.model),(p=i.submissionUsers)==null||p.forEach(u=>{u&&e.add(u)})}),J.value=Array.from(n).sort((i,p)=>i.localeCompare(p)),K.value=Array.from(e).sort((i,p)=>i.localeCompare(p)),Y.value=Array.from(r).sort((i,p)=>i.localeCompare(p))},ae=()=>{T.value=!0,o.status="",o.batch="",o.createdBy="",o.submissionUser="",o.dateRange=[],o.page=1,T.value=!1,k()},oe=n=>{o.size=n,o.page=1,k()},ne=n=>{o.page=n,k()};O(()=>o.status,A),O(()=>o.batch,A),O(()=>o.createdBy,A),O(()=>o.submissionUser,A),O(()=>o.dateRange,A,{deep:!0});const se=n=>{q.value=n,V.value=n.map(e=>e.id)},re=()=>{y.value&&(s.form.scope=V.value.length?"SELECTION":"MODEL",s.form.model=Y.value[0]??"",s.form.amount=null,s.form.status=o.status||"",s.visible=!0)},ie=()=>{if(y.value){if(!V.value.length){_.info("请先选择结算记录");return}g.form.amount=null,g.form.remark="",g.visible=!0}},de=n=>{m.visible=!0,m.targetId=n.id,m.form.amount=n.amount??n.orderAmount??0,m.form.remark=n.remark??""},ue=n=>{y.value&&(f.targetId=n.id,f.form.amount=n.amount??n.orderAmount??0,f.form.remark=n.remark??"",f.visible=!0)},me=async()=>{if(m.targetId){m.loading=!0;try{const n={amount:m.form.amount,remark:m.form.remark};await Oe(m.targetId,n),_.success("已确认"),m.visible=!1,k()}finally{m.loading=!1}}},fe=async()=>{if(y.value){if(!V.value.length){_.info("请选择记录");return}await Be.confirm("确认删除选中的结算记录吗？","提示",{type:"warning"}),await Me(V.value),_.success("已删除"),V.value=[],k()}},pe=async()=>{var n,e,r;if(y.value){if(s.form.amount===null||s.form.amount===void 0){_.warning("请输入金额");return}if(s.form.scope==="MODEL"){if(!s.form.model||!s.form.model.trim()){_.warning("请选择型号");return}s.loading=!0;try{const i={model:s.form.model.trim(),amount:s.form.amount,status:((n=s.form.status)==null?void 0:n.trim())||void 0,batch:o.batch||void 0,createdBy:((e=o.createdBy)==null?void 0:e.trim())||void 0,submissionUser:((r=o.submissionUser)==null?void 0:r.trim())||void 0};Array.isArray(o.dateRange)&&o.dateRange.length===2&&(i.startDate=o.dateRange[0],i.endDate=o.dateRange[1]),await ze(i),_.success("批量价格已更新"),s.visible=!1,k()}finally{s.loading=!1}}else{if(!V.value.length){_.warning("请选择结算记录");return}s.loading=!0;try{const i={amount:s.form.amount,remark:void 0};await Promise.all(V.value.map(p=>ee(p,i))),_.success("已更新所选记录金额"),s.visible=!1,k()}finally{s.loading=!1}}}},be=async()=>{if(y.value){if(!V.value.length){_.info("请先选择结算记录");return}g.loading=!0;try{const n={ids:[...V.value],amount:g.form.amount??void 0,remark:g.form.remark||void 0};await Le(n),_.success("批量确认成功"),g.visible=!1,V.value=[],q.value=[],k()}finally{g.loading=!1}}},ge=async()=>{if(y.value&&f.targetId){f.loading=!0;try{const n={amount:f.form.amount,remark:f.form.remark||void 0};await ee(f.targetId,n),_.success("金额已更新"),f.visible=!1,k()}finally{f.loading=!1}}},ve=async(n,e="settlements.xlsx")=>{const r=await Pe(n),i=new Blob([r.data],{type:"application/octet-stream"}),p=window.URL.createObjectURL(i),u=document.createElement("a");u.href=p,u.download=e,u.click(),window.URL.revokeObjectURL(p)},ce=async()=>{var n,e;j.value=!0;try{const r={status:o.status||void 0,batch:o.batch||void 0,createdBy:((n=o.createdBy)==null?void 0:n.trim())||void 0,submissionUser:((e=o.submissionUser)==null?void 0:e.trim())||void 0};Array.isArray(o.dateRange)&&o.dateRange.length===2&&(r.startDate=o.dateRange[0],r.endDate=o.dateRange[1]),await ve(r)}finally{j.value=!1}},ye=n=>n?n.toFixed(2):"0.00",Ve=n=>S[n??""]||"未知";return k(),(n,e)=>{const r=v("el-button"),i=v("el-option"),p=v("el-select"),u=v("el-form-item"),P=v("el-input"),ke=v("el-date-picker"),I=v("el-form"),Q=v("el-card"),C=v("el-table-column"),W=v("el-tag"),Ce=v("el-table"),_e=v("el-pagination"),z=v("el-input-number"),L=v("el-dialog"),X=v("el-radio-button"),we=v("el-radio-group"),Ue=Re("loading");return c(),E("div",Fe,[M("div",he,[e[29]||(e[29]=M("div",null,[M("h2",null,"结账管理"),M("p",{class:"sub"},"生成、确认与导出待结账记录")],-1)),M("div",$e,[y.value?(c(),D(r,{key:0,type:"primary",plain:"",onClick:re},{default:a(()=>[...e[25]||(e[25]=[d("批量设置价格",-1)])]),_:1})):R("",!0),y.value?(c(),D(r,{key:1,type:"success",plain:"",disabled:!V.value.length,onClick:ie},{default:a(()=>[...e[26]||(e[26]=[d("批量确认",-1)])]),_:1},8,["disabled"])):R("",!0),l(r,{onClick:ce,loading:j.value},{default:a(()=>[...e[27]||(e[27]=[d("导出 Excel",-1)])]),_:1},8,["loading"]),y.value?(c(),D(r,{key:2,type:"danger",plain:"",disabled:!V.value.length,onClick:fe},{default:a(()=>[...e[28]||(e[28]=[d(" 删除所选 ",-1)])]),_:1},8,["disabled"])):R("",!0)])]),l(Q,null,{default:a(()=>[l(I,{inline:!0,model:o,class:"filter-form"},{default:a(()=>[l(u,{label:"状态"},{default:a(()=>[l(p,{modelValue:o.status,"onUpdate:modelValue":e[0]||(e[0]=t=>o.status=t),clearable:"",placeholder:"全部",style:{width:"160px"}},{default:a(()=>[l(i,{label:"待结账",value:"PENDING"}),l(i,{label:"已确认",value:"CONFIRMED"})]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"批次号"},{default:a(()=>[l(P,{modelValue:o.batch,"onUpdate:modelValue":e[1]||(e[1]=t=>o.batch=t),placeholder:"例如 BATCH-20250118",clearable:""},null,8,["modelValue"])]),_:1}),l(u,{label:"日期"},{default:a(()=>[l(ke,{modelValue:o.dateRange,"onUpdate:modelValue":e[2]||(e[2]=t=>o.dateRange=t),type:"daterange","value-format":"YYYY-MM-DD","start-placeholder":"开始","end-placeholder":"结束"},null,8,["modelValue"])]),_:1}),l(u,{label:"创建人"},{default:a(()=>[l(p,{modelValue:o.createdBy,"onUpdate:modelValue":e[3]||(e[3]=t=>o.createdBy=t),placeholder:"全部",clearable:"",filterable:"","allow-create":"","default-first-option":"",style:{width:"160px"}},{default:a(()=>[(c(!0),E(F,null,G(J.value,t=>(c(),D(i,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"提交用户"},{default:a(()=>[l(p,{modelValue:o.submissionUser,"onUpdate:modelValue":e[4]||(e[4]=t=>o.submissionUser=t),placeholder:"全部",clearable:"",filterable:"","allow-create":"","default-first-option":"",style:{width:"160px"}},{default:a(()=>[(c(!0),E(F,null,G(K.value,t=>(c(),D(i,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(u,null,{default:a(()=>[l(r,{type:"primary",onClick:k},{default:a(()=>[...e[30]||(e[30]=[d("查询",-1)])]),_:1}),l(r,{onClick:ae},{default:a(()=>[...e[31]||(e[31]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(Q,{class:"table-card"},{default:a(()=>[Ee((c(),D(Ce,{data:h.value,height:"520",onSelectionChange:se},{default:a(()=>[l(C,{type:"selection",width:"48"}),l(C,{prop:"trackingNumber",label:"单号",width:"160"}),l(C,{prop:"model",label:"型号",width:"160"},{default:a(({row:t})=>[d(B(t.model||"-"),1)]),_:1}),l(C,{prop:"orderAmount",label:"订单金额",width:"140"},{default:a(({row:t})=>[d("￥"+B(ye(t.orderAmount)),1)]),_:1}),l(C,{prop:"status",label:"状态",width:"120"},{default:a(({row:t})=>[l(W,{type:t.status==="CONFIRMED"?"success":"warning"},{default:a(()=>[d(B(t.status==="CONFIRMED"?"已确认":"待结账"),1)]),_:2},1032,["type"])]),_:1}),l(C,{prop:"orderStatus",label:"订单状态",width:"140"},{default:a(({row:t})=>[t.orderStatus?(c(),D(W,{key:0,type:t.orderStatus==="PAID"?"success":"info"},{default:a(()=>[d(B(Ve(t.orderStatus)),1)]),_:2},1032,["type"])):(c(),E("span",je,"-"))]),_:1}),l(C,{prop:"orderCreatedBy",label:"创建人",width:"140"},{default:a(({row:t})=>[d(B(t.orderCreatedBy||"-"),1)]),_:1}),l(C,{prop:"submissionUsers",label:"提交用户",width:"160"},{default:a(({row:t})=>[d(B(t.submissionUsers&&t.submissionUsers.length?t.submissionUsers.join("、"):"-"),1)]),_:1}),l(C,{prop:"settleBatch",label:"批次",width:"180"}),l(C,{prop:"payableAt",label:"应付日期",width:"140"}),l(C,{prop:"remark",label:"备注"}),l(C,{label:"操作",width:"160"},{default:a(({row:t})=>[y.value?(c(),D(r,{key:0,link:"",type:"primary",onClick:De=>ue(t)},{default:a(()=>[...e[32]||(e[32]=[d(" 修改金额 ",-1)])]),_:1},8,["onClick"])):R("",!0),y.value&&t.status!=="CONFIRMED"?(c(),D(r,{key:1,link:"",type:"primary",onClick:De=>de(t)},{default:a(()=>[...e[33]||(e[33]=[d(" 确认 ",-1)])]),_:1},8,["onClick"])):R("",!0)]),_:1})]),_:1},8,["data"])),[[Ue,$.value]]),l(_e,{"current-page":o.page,"onUpdate:currentPage":e[5]||(e[5]=t=>o.page=t),"page-size":o.size,"onUpdate:pageSize":e[6]||(e[6]=t=>o.size=t),total:H.value,layout:"total, sizes, prev, pager, next","page-sizes":[10,20,50],style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:oe,onCurrentChange:ne},null,8,["current-page","page-size","total"])]),_:1}),l(L,{modelValue:m.visible,"onUpdate:modelValue":e[10]||(e[10]=t=>m.visible=t),title:"确认结账",width:"480px"},{footer:a(()=>[l(r,{onClick:e[9]||(e[9]=t=>m.visible=!1)},{default:a(()=>[...e[34]||(e[34]=[d("取消",-1)])]),_:1}),l(r,{type:"primary",loading:m.loading,onClick:me},{default:a(()=>[...e[35]||(e[35]=[d("确认",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{"label-width":"100px"},{default:a(()=>[l(u,{label:"金额"},{default:a(()=>[l(z,{modelValue:m.form.amount,"onUpdate:modelValue":e[7]||(e[7]=t=>m.form.amount=t),min:0,step:10},null,8,["modelValue"])]),_:1}),l(u,{label:"备注"},{default:a(()=>[l(P,{modelValue:m.form.remark,"onUpdate:modelValue":e[8]||(e[8]=t=>m.form.remark=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(L,{modelValue:s.visible,"onUpdate:modelValue":e[16]||(e[16]=t=>s.visible=t),title:"批量设置价格",width:"420px"},{footer:a(()=>[l(r,{onClick:e[15]||(e[15]=t=>s.visible=!1)},{default:a(()=>[...e[38]||(e[38]=[d("取消",-1)])]),_:1}),l(r,{type:"primary",loading:s.loading,onClick:pe},{default:a(()=>[...e[39]||(e[39]=[d("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{"label-width":"100px"},{default:a(()=>[l(u,{label:"作用范围"},{default:a(()=>[l(we,{modelValue:s.form.scope,"onUpdate:modelValue":e[11]||(e[11]=t=>s.form.scope=t)},{default:a(()=>[l(X,{label:"MODEL"},{default:a(()=>[...e[36]||(e[36]=[d("按型号筛选",-1)])]),_:1}),l(X,{label:"SELECTION",disabled:!V.value.length},{default:a(()=>[...e[37]||(e[37]=[d("已选择记录",-1)])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),s.form.scope==="MODEL"?(c(),E(F,{key:0},[l(u,{label:"型号"},{default:a(()=>[l(p,{modelValue:s.form.model,"onUpdate:modelValue":e[12]||(e[12]=t=>s.form.model=t),placeholder:"请选择型号",filterable:"","allow-create":""},{default:a(()=>[(c(!0),E(F,null,G(Y.value,t=>(c(),D(i,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"状态范围"},{default:a(()=>[l(p,{modelValue:s.form.status,"onUpdate:modelValue":e[13]||(e[13]=t=>s.form.status=t),placeholder:"全部",clearable:"",style:{width:"200px"}},{default:a(()=>[l(i,{label:"待结账",value:"PENDING"}),l(i,{label:"已确认",value:"CONFIRMED"})]),_:1},8,["modelValue"])]),_:1})],64)):R("",!0),l(u,{label:"金额"},{default:a(()=>[l(z,{modelValue:s.form.amount,"onUpdate:modelValue":e[14]||(e[14]=t=>s.form.amount=t),min:0,step:10},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(L,{modelValue:g.visible,"onUpdate:modelValue":e[20]||(e[20]=t=>g.visible=t),title:"批量确认",width:"420px"},{footer:a(()=>[l(r,{onClick:e[19]||(e[19]=t=>g.visible=!1)},{default:a(()=>[...e[40]||(e[40]=[d("取消",-1)])]),_:1}),l(r,{type:"primary",loading:g.loading,onClick:be},{default:a(()=>[...e[41]||(e[41]=[d("确认",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{"label-width":"100px"},{default:a(()=>[l(u,{label:"金额"},{default:a(()=>[l(z,{modelValue:g.form.amount,"onUpdate:modelValue":e[17]||(e[17]=t=>g.form.amount=t),min:0,step:10,placeholder:"保留原金额"},null,8,["modelValue"])]),_:1}),l(u,{label:"备注"},{default:a(()=>[l(P,{modelValue:g.form.remark,"onUpdate:modelValue":e[18]||(e[18]=t=>g.form.remark=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(L,{modelValue:f.visible,"onUpdate:modelValue":e[24]||(e[24]=t=>f.visible=t),title:"修改金额",width:"420px"},{footer:a(()=>[l(r,{onClick:e[23]||(e[23]=t=>f.visible=!1)},{default:a(()=>[...e[42]||(e[42]=[d("取消",-1)])]),_:1}),l(r,{type:"primary",loading:f.loading,onClick:ge},{default:a(()=>[...e[43]||(e[43]=[d("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{"label-width":"100px"},{default:a(()=>[l(u,{label:"金额"},{default:a(()=>[l(z,{modelValue:f.form.amount,"onUpdate:modelValue":e[21]||(e[21]=t=>f.form.amount=t),min:0,step:10},null,8,["modelValue"])]),_:1}),l(u,{label:"备注"},{default:a(()=>[l(P,{modelValue:f.form.remark,"onUpdate:modelValue":e[22]||(e[22]=t=>f.form.remark=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Ge=Ae(Te,[["__scopeId","data-v-1fb74df8"]]);export{Ge as default};

import{y as D,d as de,u as ue,j,a as G,r as c,c as T,h as V,b as t,m as R,n as Y,w as o,e as r,o as _,i,v as pe,x as me,t as x,E as y,z as ce,_ as fe}from"./index-CbheMMSM.js";const ge=d=>{const f=new URLSearchParams;return Object.entries(d).forEach(([v,g])=>{g==null||g===""||(Array.isArray(g)?g.forEach(n=>{n!=null&&n!==""&&f.append(v,String(n))}):f.append(v,String(g)))}),f.toString()},be=d=>D.get("/settlements",{params:d}),ve=d=>D.post("/settlements/generate",d),_e=(d,f)=>D.put(`/settlements/${d}/confirm`,f),ye=d=>D.delete("/settlements",{data:d}),ke=async d=>await D.get("/settlements/export",{params:d,paramsSerializer:()=>ge(d),responseType:"blob"}),we={class:"page"},Ce={class:"page-header"},Ve={class:"actions"},xe={key:1},De=de({__name:"SettlementsView",setup(d){const f=ue(),v=j(()=>{var a;return((a=f.user)==null?void 0:a.role)==="ADMIN"}),g={PENDING:"待结账",CONFIRMED:"已确认",PAID:"已打款",UNPAID:"未打款",NOT_RECEIVED:"未收货"},n=G({status:"",batch:"",dateRange:[],page:1,size:20}),E=c([]),P=c(0),h=c(!1),I=c(!1),k=c([]),z=c([]),w=c(!1),C=c(""),U=c(!1),s=G({visible:!1,loading:!1,targetId:0,form:{amount:0,remark:""}}),$=j(()=>{const a={page:n.page,size:n.size,status:n.status||void 0,batch:n.batch||void 0};return n.dateRange.length===2&&(a.startDate=n.dateRange[0],a.endDate=n.dateRange[1]),a}),b=async()=>{h.value=!0;try{const a=await be($.value);E.value=a.records,P.value=a.total}finally{h.value=!1}},H=()=>{n.status="",n.batch="",n.dateRange=[],n.page=1,b()},q=a=>{n.size=a,n.page=1,b()},J=a=>{n.page=a,b()},K=a=>{z.value=a,k.value=a.map(e=>e.id)},Q=()=>{const a=(z.value.length?z.value:E.value.filter(e=>e.status==="PENDING")).map(e=>e.trackingNumber).filter(Boolean);C.value=a.join(`
`),a.length||y.info("暂无可用的待结账单号，请先选择或筛选记录"),w.value=!0},W=async()=>{const a=C.value.split(/\n|,|;/).map(e=>e.trim()).filter(Boolean);if(!a.length){y.warning("请输入单号");return}U.value=!0;try{await ve({trackingNumbers:a}),y.success("生成成功，正在写入 Excel"),w.value=!1,C.value="",b(),await B({trackingNumbers:a},"pending-settlements.xlsx")}finally{U.value=!1}},X=a=>{s.visible=!0,s.targetId=a.id,s.form.amount=a.amount??0,s.form.remark=a.remark??""},Z=async()=>{if(s.targetId){s.loading=!0;try{const a={amount:s.form.amount,remark:s.form.remark};await _e(s.targetId,a),y.success("已确认"),s.visible=!1,b()}finally{s.loading=!1}}},ee=async()=>{if(v.value){if(!k.value.length){y.info("请选择记录");return}await ce.confirm("确认删除选中的结算记录吗？","提示",{type:"warning"}),await ye(k.value),y.success("已删除"),k.value=[],b()}},B=async(a,e="settlements.xlsx")=>{const u=await ke(a),S=new Blob([u.data],{type:"application/octet-stream"}),N=window.URL.createObjectURL(S),p=document.createElement("a");p.href=N,p.download=e,p.click(),window.URL.revokeObjectURL(N)},te=async()=>{I.value=!0;try{const a={status:n.status||void 0,batch:n.batch||void 0};n.dateRange.length===2&&(a.startDate=n.dateRange[0],a.endDate=n.dateRange[1]),await B(a)}finally{I.value=!1}},ae=a=>a?a.toFixed(2):"0.00",le=a=>g[a??""]||"未知";return b(),(a,e)=>{const u=r("el-button"),S=r("el-option"),N=r("el-select"),p=r("el-form-item"),A=r("el-input"),ne=r("el-date-picker"),M=r("el-form"),O=r("el-card"),m=r("el-table-column"),F=r("el-tag"),oe=r("el-table"),se=r("el-pagination"),L=r("el-dialog"),re=r("el-input-number"),ie=me("loading");return _(),T("div",we,[V("div",Ce,[e[15]||(e[15]=V("div",null,[V("h2",null,"结账管理"),V("p",{class:"sub"},"生成、确认与导出待结账记录")],-1)),V("div",Ve,[t(u,{onClick:te,loading:I.value},{default:o(()=>[...e[12]||(e[12]=[i("导出 Excel",-1)])]),_:1},8,["loading"]),t(u,{type:"primary",onClick:Q},{default:o(()=>[...e[13]||(e[13]=[i("生成待结账",-1)])]),_:1}),v.value?(_(),R(u,{key:0,type:"danger",plain:"",disabled:!k.value.length,onClick:ee},{default:o(()=>[...e[14]||(e[14]=[i(" 删除所选 ",-1)])]),_:1},8,["disabled"])):Y("",!0)])]),t(O,null,{default:o(()=>[t(M,{inline:!0,model:n,class:"filter-form"},{default:o(()=>[t(p,{label:"状态"},{default:o(()=>[t(N,{modelValue:n.status,"onUpdate:modelValue":e[0]||(e[0]=l=>n.status=l),clearable:"",placeholder:"全部",style:{width:"160px"}},{default:o(()=>[t(S,{label:"待结账",value:"PENDING"}),t(S,{label:"已确认",value:"CONFIRMED"})]),_:1},8,["modelValue"])]),_:1}),t(p,{label:"批次号"},{default:o(()=>[t(A,{modelValue:n.batch,"onUpdate:modelValue":e[1]||(e[1]=l=>n.batch=l),placeholder:"例如 BATCH-20250118",clearable:""},null,8,["modelValue"])]),_:1}),t(p,{label:"日期"},{default:o(()=>[t(ne,{modelValue:n.dateRange,"onUpdate:modelValue":e[2]||(e[2]=l=>n.dateRange=l),type:"daterange","value-format":"YYYY-MM-DD","start-placeholder":"开始","end-placeholder":"结束"},null,8,["modelValue"])]),_:1}),t(p,null,{default:o(()=>[t(u,{type:"primary",onClick:b},{default:o(()=>[...e[16]||(e[16]=[i("查询",-1)])]),_:1}),t(u,{onClick:H},{default:o(()=>[...e[17]||(e[17]=[i("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(O,{class:"table-card"},{default:o(()=>[pe((_(),R(oe,{data:E.value,height:"520",onSelectionChange:K},{default:o(()=>[t(m,{type:"selection",width:"48"}),t(m,{prop:"trackingNumber",label:"单号",width:"160"}),t(m,{prop:"amount",label:"金额",width:"120"},{default:o(({row:l})=>[i(x(l.amount??"-")+" "+x(l.currency),1)]),_:1}),t(m,{prop:"orderAmount",label:"订单金额",width:"140"},{default:o(({row:l})=>[i("￥"+x(ae(l.orderAmount)),1)]),_:1}),t(m,{prop:"status",label:"状态",width:"120"},{default:o(({row:l})=>[t(F,{type:l.status==="CONFIRMED"?"success":"warning"},{default:o(()=>[i(x(l.status==="CONFIRMED"?"已确认":"待结账"),1)]),_:2},1032,["type"])]),_:1}),t(m,{prop:"orderStatus",label:"订单状态",width:"140"},{default:o(({row:l})=>[l.orderStatus?(_(),R(F,{key:0,type:l.orderStatus==="PAID"?"success":"info"},{default:o(()=>[i(x(le(l.orderStatus)),1)]),_:2},1032,["type"])):(_(),T("span",xe,"-"))]),_:1}),t(m,{prop:"settleBatch",label:"批次",width:"180"}),t(m,{prop:"payableAt",label:"应付日期",width:"140"}),t(m,{prop:"remark",label:"备注"}),t(m,{label:"操作",width:"160"},{default:o(({row:l})=>[v.value&&l.status!=="CONFIRMED"?(_(),R(u,{key:0,link:"",type:"primary",onClick:Se=>X(l)},{default:o(()=>[...e[18]||(e[18]=[i(" 确认 ",-1)])]),_:1},8,["onClick"])):Y("",!0)]),_:1})]),_:1},8,["data"])),[[ie,h.value]]),t(se,{"current-page":n.page,"onUpdate:currentPage":e[3]||(e[3]=l=>n.page=l),"page-size":n.size,"onUpdate:pageSize":e[4]||(e[4]=l=>n.size=l),total:P.value,layout:"total, sizes, prev, pager, next","page-sizes":[10,20,50],style:{"margin-top":"12px","justify-content":"flex-end"},onSizeChange:q,onCurrentChange:J},null,8,["current-page","page-size","total"])]),_:1}),t(L,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=l=>w.value=l),title:"生成待结账",width:"600px"},{footer:o(()=>[t(u,{onClick:e[6]||(e[6]=l=>w.value=!1)},{default:o(()=>[...e[19]||(e[19]=[i("取消",-1)])]),_:1}),t(u,{type:"primary",loading:U.value,onClick:W},{default:o(()=>[...e[20]||(e[20]=[i("生成",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(M,{"label-width":"120px"},{default:o(()=>[t(p,{label:"单号列表"},{default:o(()=>[t(A,{modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=l=>C.value=l),type:"textarea",rows:4,placeholder:"每行一个单号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(L,{modelValue:s.visible,"onUpdate:modelValue":e[11]||(e[11]=l=>s.visible=l),title:"确认结账",width:"480px"},{footer:o(()=>[t(u,{onClick:e[10]||(e[10]=l=>s.visible=!1)},{default:o(()=>[...e[21]||(e[21]=[i("取消",-1)])]),_:1}),t(u,{type:"primary",loading:s.loading,onClick:Z},{default:o(()=>[...e[22]||(e[22]=[i("确认",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(M,{"label-width":"100px"},{default:o(()=>[t(p,{label:"金额"},{default:o(()=>[t(re,{modelValue:s.form.amount,"onUpdate:modelValue":e[8]||(e[8]=l=>s.form.amount=l),min:0,step:10},null,8,["modelValue"])]),_:1}),t(p,{label:"备注"},{default:o(()=>[t(A,{modelValue:s.form.remark,"onUpdate:modelValue":e[9]||(e[9]=l=>s.form.remark=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Re=fe(De,[["__scopeId","data-v-2040570b"]]);export{Re as default};

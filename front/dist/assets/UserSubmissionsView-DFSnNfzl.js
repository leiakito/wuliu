import{d as ve,u as _e,j as we,r as S,a as A,k as J,z as ye,c as U,e as u,b as t,m as D,n as z,w as l,g as d,t as w,f as g,F as Q,s as W,v as ke,x as he,E as C,i as Ne,o as y,_ as Ve}from"./index-xnLysfLr.js";import{f as Ce,a as xe,s as Se,b as Ue}from"./submissions-CGDh9ZA7.js";const De={class:"page submissions-page"},ze={class:"page-header"},Le={class:"header-actions"},Ee={key:0},Ae={key:0,class:"batch-preview"},Te={class:"batch-tags"},Be=ve({__name:"UserSubmissionsView",setup(Ie){const X=_e(),Z=Ne(),h=we(()=>{var s;return((s=X.user)==null?void 0:s.role)==="ADMIN"}),T=[{label:"待处理",value:"PENDING",type:"warning"},{label:"处理中",value:"PROCESSING",type:"info"},{label:"已完成",value:"COMPLETED",type:"success"}],O=s=>{const e=T.find(i=>i.value===s);return e?e.label:"待处理"},H=s=>{const e=T.find(i=>i.value===s);return(e==null?void 0:e.type)??"warning"},P=[{value:"PAID",label:"已打款",tag:"success"},{value:"UNPAID",label:"未打款",tag:"warning"},{value:"NOT_RECEIVED",label:"未收货",tag:"info"}],M=s=>{var e;return((e=P.find(i=>i.value===s))==null?void 0:e.label)??"未知"},K=s=>{var e;return((e=P.find(i=>i.value===s))==null?void 0:e.tag)??"info"},L=S(),N=A({trackingNumber:""}),Y={trackingNumber:[{required:!0,message:"请输入单号",trigger:"blur"}]},B=S(!1),I=S(!1),R=S(!1),x=S([]),b=A({page:1,size:10,total:0}),c=A({status:"",trackingNumber:"",username:""}),o=A({visible:!1,loading:!1,raw:"",list:[]}),ee=()=>({page:b.page,size:b.size,status:c.status||void 0,trackingNumber:c.trackingNumber?c.trackingNumber.trim():void 0,username:h.value&&c.username?c.username.trim():void 0}),V=async()=>{I.value=!0;try{const s=ee(),e=h.value?await Ce(s):await xe(s);x.value=e.records,b.total=e.total}finally{I.value=!1}},te=async()=>{var i,m;if(!L.value)return;try{await L.value.validate()}catch{return}const s=N.trackingNumber.trim();if(!s)return;if(x.value.some(p=>{var r;return((r=p.trackingNumber)==null?void 0:r.trim().toUpperCase())===s.toUpperCase()})){C.warning("该单号已提交，请勿重复提交");return}N.trackingNumber=s,B.value=!0;try{await Se(N),C.success("提交成功"),j(),await V()}catch(p){const r=((m=(i=p==null?void 0:p.response)==null?void 0:i.data)==null?void 0:m.message)??"提交失败，请稍后重试";typeof r=="string"&&r.includes("已提交")?C.warning(r):C.error(r)}finally{B.value=!1}},j=()=>{var s;N.trackingNumber="",(s=L.value)==null||s.clearValidate()},F=()=>{b.page=1,V()},le=()=>{c.status="",c.trackingNumber="",c.username="",F()},ae=s=>{b.page=s,V()},se=s=>{b.size=s,b.page=1,V()},ne=()=>{o.raw="",o.list=[],o.visible=!0},oe=()=>{const s=o.raw??"",e=new Set,i=[];s.split(/\n+/).forEach(p=>{const r=p.replace(/["“”]/g," ").trim();if(!r)return;const v=/[A-Za-z0-9-]{4,}/g,n=r.match(v);if(!n||!n.length)return;let _=n[0].trim();if(!_||(_.endsWith("-")&&(_=_.replace(/-+$/g,"")),_.length<12))return;const E=_.toUpperCase();e.has(E)||(e.add(E),i.push(_))}),o.list=i};J(()=>o.raw,()=>{oe()});const re=async()=>{if(!o.list.length){C.warning("请先输入单号");return}o.loading=!0;try{const s={trackingNumbers:[...o.list],rawContent:o.raw};await Ue(s),C.success("批量提交成功"),o.visible=!1,V()}finally{o.loading=!1}},ie=()=>{Z.push("/submission-logs")},$=s=>s?s.replace("T"," ").slice(0,19):"-",G=s=>s?s.replace("T"," ").slice(0,19):"-",ue=()=>{if(!x.value.length){C.info("暂无可导出的记录");return}R.value=!0;try{const s=["下单日期","订单时间","单号","型号","物流公司","订单状态","提交状态","提交时间"],e=x.value.map(v=>{const n=v.order;return[(n==null?void 0:n.orderDate)??"-",G(n==null?void 0:n.orderTime),v.trackingNumber??"-",(n==null?void 0:n.model)??"-",(n==null?void 0:n.category)??"-",M(n==null?void 0:n.status),O(v.status),$(v.createdAt)]}),i=[s,...e].map(v=>v.map(n=>`"${String(n??"").replace(/"/g,'""')}"`).join(",")).join(`
`),m=new Blob([i],{type:"application/vnd.ms-excel"}),p=window.URL.createObjectURL(m),r=document.createElement("a");r.href=p,r.download=`submissions-${new Date().toISOString().slice(0,10)}.xls`,r.click(),window.URL.revokeObjectURL(p)}finally{R.value=!1}};return J(h,()=>{b.page=1,V()}),ye(()=>{V()}),(s,e)=>{const i=g("el-tag"),m=g("el-button"),p=g("el-input"),r=g("el-form-item"),v=g("el-form"),n=g("el-card"),_=g("el-col"),E=g("el-row"),de=g("el-option"),ce=g("el-select"),k=g("el-table-column"),me=g("el-table"),pe=g("el-pagination"),ge=g("el-scrollbar"),fe=g("el-dialog"),be=he("loading");return y(),U("div",De,[u("div",ze,[e[10]||(e[10]=u("div",null,[u("h2",null,"单号提交"),u("p",{class:"sub"},"提交后即可在下方列表中查看处理进度")],-1)),u("div",Le,[t(i,{type:"info"},{default:l(()=>[d(w(h.value?"管理员视图":"个人视图"),1)]),_:1}),h.value?(y(),D(m,{key:0,type:"primary",plain:"",onClick:ie},{default:l(()=>[...e[9]||(e[9]=[d("提交记录",-1)])]),_:1})):z("",!0)])]),t(E,{gutter:16,class:"form-row"},{default:l(()=>[t(_,{xs:24,md:12},{default:l(()=>[t(n,null,{header:l(()=>[...e[11]||(e[11]=[u("div",{class:"card-header"},[u("span",null,"提交单号"),u("small",null,"系统会自动匹配订单信息")],-1)])]),default:l(()=>[t(v,{ref_key:"formRef",ref:L,model:N,rules:Y,"label-width":"90px"},{default:l(()=>[t(r,{label:"单号",prop:"trackingNumber"},{default:l(()=>[t(p,{modelValue:N.trackingNumber,"onUpdate:modelValue":e[0]||(e[0]=a=>N.trackingNumber=a),modelModifiers:{trim:!0},placeholder:"请输入或粘贴物流单号"},null,8,["modelValue"])]),_:1}),t(r,null,{default:l(()=>[t(m,{type:"primary",loading:B.value,onClick:te},{default:l(()=>[...e[12]||(e[12]=[d("提交单号",-1)])]),_:1},8,["loading"]),t(m,{onClick:j},{default:l(()=>[...e[13]||(e[13]=[d("清空",-1)])]),_:1}),t(m,{text:"",onClick:ne},{default:l(()=>[...e[14]||(e[14]=[d("批量提交",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),t(_,{xs:24,md:12},{default:l(()=>[t(n,{class:"tips-card"},{header:l(()=>[...e[15]||(e[15]=[u("div",{class:"card-header"},[u("span",null,"操作说明")],-1)])]),default:l(()=>[u("ul",null,[e[16]||(e[16]=u("li",null,"状态默认为「待处理」，运营/财务确认后会更新状态",-1)),e[17]||(e[17]=u("li",null,"系统自动关联订单金额、型号、物流公司等信息",-1)),h.value?(y(),U("li",Ee,"管理员可使用下方筛选器按用户名或状态查询所有提交")):z("",!0)])]),_:1})]),_:1})]),_:1}),t(n,{class:"filter-card"},{default:l(()=>[t(v,{inline:!0,model:c},{default:l(()=>[t(r,{label:"状态"},{default:l(()=>[t(ce,{modelValue:c.status,"onUpdate:modelValue":e[1]||(e[1]=a=>c.status=a),placeholder:"全部",clearable:"",style:{width:"160px"}},{default:l(()=>[(y(),U(Q,null,W(T,a=>t(de,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(r,{label:"单号"},{default:l(()=>[t(p,{modelValue:c.trackingNumber,"onUpdate:modelValue":e[2]||(e[2]=a=>c.trackingNumber=a),placeholder:"支持模糊搜索",clearable:""},null,8,["modelValue"])]),_:1}),h.value?(y(),D(r,{key:0,label:"用户名"},{default:l(()=>[t(p,{modelValue:c.username,"onUpdate:modelValue":e[3]||(e[3]=a=>c.username=a),placeholder:"仅管理员可筛选",clearable:""},null,8,["modelValue"])]),_:1})):z("",!0),t(r,null,{default:l(()=>[t(m,{type:"primary",onClick:F},{default:l(()=>[...e[18]||(e[18]=[d("查询",-1)])]),_:1}),t(m,{onClick:le},{default:l(()=>[...e[19]||(e[19]=[d("重置",-1)])]),_:1}),t(m,{text:"",loading:R.value,disabled:!x.value.length,onClick:ue},{default:l(()=>[...e[20]||(e[20]=[d("导出 Excel",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),t(n,{class:"table-card"},{default:l(()=>[ke((y(),D(me,{data:x.value,style:{width:"100%"}},{default:l(()=>[h.value?(y(),D(k,{key:0,prop:"username",label:"用户名",width:"140"})):z("",!0),t(k,{label:"下单日期",width:"140"},{default:l(({row:a})=>{var f;return[d(w(((f=a.order)==null?void 0:f.orderDate)??"-"),1)]}),_:1}),t(k,{label:"订单时间",width:"180"},{default:l(({row:a})=>{var f;return[d(w(G((f=a.order)==null?void 0:f.orderTime)),1)]}),_:1}),t(k,{prop:"trackingNumber",label:"单号","min-width":"160"}),t(k,{label:"型号","min-width":"160"},{default:l(({row:a})=>{var f;return[d(w(((f=a.order)==null?void 0:f.model)??"-"),1)]}),_:1}),t(k,{label:"物流公司",width:"120"},{default:l(({row:a})=>{var f;return[d(w(((f=a.order)==null?void 0:f.category)??"-"),1)]}),_:1}),t(k,{label:"订单状态",width:"140"},{default:l(({row:a})=>{var f;return[t(i,{type:K((f=a.order)==null?void 0:f.status)},{default:l(()=>{var q;return[d(w(M((q=a.order)==null?void 0:q.status)),1)]}),_:2},1032,["type"])]}),_:1}),t(k,{prop:"status",label:"提交状态",width:"140"},{default:l(({row:a})=>[t(i,{type:H(a.status)},{default:l(()=>[d(w(O(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(k,{prop:"createdAt",label:"提交时间",width:"180"},{default:l(({row:a})=>[d(w($(a.createdAt)),1)]),_:1})]),_:1},8,["data"])),[[be,I.value]]),t(pe,{"current-page":b.page,"onUpdate:currentPage":e[4]||(e[4]=a=>b.page=a),"page-size":b.size,"onUpdate:pageSize":e[5]||(e[5]=a=>b.size=a),total:b.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",background:"",class:"table-pagination",onCurrentChange:ae,onSizeChange:se},null,8,["current-page","page-size","total"])]),_:1}),t(fe,{modelValue:o.visible,"onUpdate:modelValue":e[8]||(e[8]=a=>o.visible=a),title:"批量提交单号",width:"520px"},{footer:l(()=>[t(m,{onClick:e[7]||(e[7]=a=>o.visible=!1)},{default:l(()=>[...e[21]||(e[21]=[d("取消",-1)])]),_:1}),t(m,{type:"primary",loading:o.loading,onClick:re},{default:l(()=>[...e[22]||(e[22]=[d("提交",-1)])]),_:1},8,["loading"])]),default:l(()=>[e[23]||(e[23]=u("div",{class:"batch-tip"},[u("p",null,"支持一次粘贴多个单号，系统会自动提取每行中的第一个编号。"),u("p",null,"批量提交请确保每个单号单独换行。"),u("p",null,"示例："),u("pre",{class:"batch-example"},`JDX044863610899
343138058920`)],-1)),t(p,{modelValue:o.raw,"onUpdate:modelValue":e[6]||(e[6]=a=>o.raw=a),type:"textarea",rows:8,placeholder:"每行一个单号，可附带备注"},null,8,["modelValue"]),o.list.length?(y(),U("div",Ae,[u("span",null,"已识别 "+w(o.list.length)+" 个单号：",1),t(ge,{"max-height":"120"},{default:l(()=>[u("div",Te,[(y(!0),U(Q,null,W(o.list,a=>(y(),D(i,{key:a,class:"tag-item"},{default:l(()=>[d(w(a),1)]),_:2},1024))),128))])]),_:1})])):z("",!0)]),_:1},8,["modelValue"])])}}}),Pe=Ve(Be,[["__scopeId","data-v-a90b6bb2"]]);export{Pe as default};
